<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Finance Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style_enhanced.css') }}">
</head>
<body>
<div class="container-fluid h-100">
<div class="row h-100">

<!-- SIDEBAR -->
<div class="col-md-3 menu-sidebar">
    <div class="sidebar-brand">
        <div class="brand-icon"><i class="fas fa-chart-pie"></i></div>
        <div class="brand-text">
            <span class="brand-name">FinAssist</span>
            <span class="brand-sub">Virtual Finance Assistant</span>
        </div>
    </div>
    <div class="sidebar-section">
        <button class="menu-btn home-btn" onclick="goHome()">
            <div class="btn-icon"><i class="fas fa-home"></i></div>
            <span>Home</span>
        </button>
    </div>
    <div class="sidebar-divider"><span>TOOLS</span></div>
    <div class="menu-categories">
        <button class="menu-btn" onclick="showForm('stock')">
            <div class="btn-icon"><i class="fas fa-chart-line"></i></div>
            <span>Stock Information</span>
        </button>
        <button class="menu-btn" onclick="showForm('emi')">
            <div class="btn-icon"><i class="fas fa-building"></i></div>
            <span>EMI Calculator</span>
        </button>
        <button class="menu-btn" onclick="showForm('sip')">
            <div class="btn-icon"><i class="fas fa-coins"></i></div>
            <span>SIP Calculator</span>
        </button>
        <button class="menu-btn" onclick="showForm('stepsip')">
            <div class="btn-icon"><i class="fas fa-chart-line"></i></div>
            <span>Step-up SIP</span>
        </button>
        <button class="menu-btn" onclick="showForm('fd')">
            <div class="btn-icon"><i class="fas fa-piggy-bank"></i></div>
            <span>Fixed Deposit</span>
        </button>
        <button class="menu-btn" onclick="showForm('mf')">
            <div class="btn-icon"><i class="fas fa-layer-group"></i></div>
            <span>Mutual Funds</span>
        </button>
        <button class="menu-btn" onclick="showForm('zakat')">
            <div class="btn-icon"><i class="fas fa-star-and-crescent"></i></div>
            <span>Zakat Calculator</span>
        </button>
    </div>
    <div class="sidebar-divider"><span>LEARN</span></div>
    <div class="menu-categories">
        <button class="menu-btn" onclick="showForm('glossary')">
            <div class="btn-icon"><i class="fas fa-book-open"></i></div>
            <span>Finance Glossary</span>
        </button>
    </div>
    <div class="sidebar-divider"><span>CHAT</span></div>
    <div class="menu-categories">
        <button class="menu-btn chat-mode-btn" onclick="showForm('chat')">
            <div class="btn-icon"><i class="fas fa-comments"></i></div>
            <span>Chat Mode</span>
        </button>
    </div>
    <div class="sidebar-divider"><span>MARKET</span></div>
    <div class="menu-categories">
        <button class="menu-btn" onclick="showForm('news')">
            <div class="btn-icon"><i class="fas fa-newspaper"></i></div>
            <span>Market News</span>
        </button>
        <button class="menu-btn" onclick="showForm('currency')">
            <div class="btn-icon"><i class="fas fa-exchange-alt"></i></div>
            <span>Currency Rates</span>
        </button>
        <button class="menu-btn" onclick="showForm('metals')">
            <div class="btn-icon"><i class="fas fa-gem"></i></div>
            <span>Gold &amp; Silver</span>
        </button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="col-md-9 main-content">
<div class="chat-container">
<div class="card">

    <!-- Header -->
    <div class="card-header">
        <h5><i class="fas fa-robot"></i> Virtual Finance Assistant</h5>
    </div>

    <!-- Ticker Bar -->
    <div id="tickerBar" class="ticker-bar">
        <div class="ticker-label">
            <i class="fas fa-chart-line"></i>
            <span id="tickerStatus">LIVE</span>
        </div>
        <div class="ticker-track-wrap">
            <div class="ticker-track" id="tickerTrack">
                <span class="ticker-loading">Fetching market data‚Ä¶</span>
            </div>
        </div>
        <button class="ticker-refresh" onclick="fetchTicker()" title="Refresh">
            <i class="fas fa-sync-alt" id="tickerRefreshIcon"></i>
        </button>
    </div>

    <!-- HOME SCREEN -->
    <div class="card-body" id="welcomeScreen">
        <div class="home-page">
            <div class="home-hero">
                <div class="home-hero-icon"><i class="fas fa-chart-pie"></i></div>
                <h1>Virtual Finance Assistant</h1>
                <p>Your all-in-one tool for smart financial decisions. Explore the features below.</p>
            </div>

            <!-- 5 cards: 2x2 grid + Chat spanning right column both rows -->
            <div class="features-grid">

                <!-- R1C1: Stock -->
                <div class="feature-card" onclick="showForm('stock')">
                    <div class="feature-icon stock-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="feature-body">
                        <h3>Stock Information</h3>
                        <p>Live NSE prices, daily &amp; weekly performance for top Indian stocks</p>
                        <div class="feature-tags"><span>Live Prices</span><span>NSE Data</span><span>Weekly View</span></div>
                    </div>
                    <div class="feature-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>

                <!-- R1C2: EMI -->
                <div class="feature-card" onclick="showForm('emi')">
                    <div class="feature-icon emi-icon"><i class="fas fa-building"></i></div>
                    <div class="feature-body">
                        <h3>EMI Calculator</h3>
                        <p>Calculate monthly loan payments for home, car or personal loans</p>
                        <div class="feature-tags"><span>Home Loan</span><span>Car Loan</span><span>Interest</span></div>
                    </div>
                    <div class="feature-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>

                <!-- R1+R2 C3: Chat (spans 2 rows) -->
                <div class="feature-card chat-feature-card" onclick="showForm('chat')">
                    <div class="feature-icon chat-icon"><i class="fas fa-comments"></i></div>
                    <div class="feature-body">
                        <h3>Chat Mode</h3>
                        <p>Ask anything about finance, investments, markets or get help using any tool</p>
                        <div class="feature-tags"><span>AI Powered</span><span>Ask Anything</span><span>Finance Tips</span></div>
                    </div>
                    <div class="feature-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>

                <!-- R2C1: SIP -->
                <div class="feature-card" onclick="showForm('sip')">
                    <div class="feature-icon sip-icon"><i class="fas fa-coins"></i></div>
                    <div class="feature-body">
                        <h3>SIP Calculator</h3>
                        <p>Project your mutual fund returns with systematic investment planning</p>
                        <div class="feature-tags"><span>Mutual Funds</span><span>Returns</span><span>Projections</span></div>
                    </div>
                    <div class="feature-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>

                <!-- R2C2: FD -->
                <div class="feature-card" onclick="showForm('fd')">
                    <div class="feature-icon fd-icon"><i class="fas fa-piggy-bank"></i></div>
                    <div class="feature-body">
                        <h3>Fixed Deposit</h3>
                        <p>Calculate guaranteed returns on your fixed deposit investments</p>
                        <div class="feature-tags"><span>Guaranteed</span><span>Maturity</span><span>Safe</span></div>
                    </div>
                    <div class="feature-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>

            </div><!-- end features-grid -->

            <!-- Market Widgets -->
            <div class="market-widgets-grid">
                <div class="feature-card widget-card">
                    <div class="widget-header">
                        <div class="widget-title"><i class="fas fa-arrow-trend-up"></i> Top Gainers</div>
                        <div class="widget-status">Live</div>
                    </div>
                    <div class="widget-body" id="topGainersList"><div class="widget-loading">Loading...</div></div>
                </div>
                <div class="feature-card widget-card">
                    <div class="widget-header">
                        <div class="widget-title"><i class="fas fa-arrow-trend-down"></i> Top Losers</div>
                        <div class="widget-status">Live</div>
                    </div>
                    <div class="widget-body" id="topLosersList"><div class="widget-loading">Loading...</div></div>
                </div>
                <div class="feature-card widget-card">
                    <div class="widget-header">
                        <div class="widget-title"><i class="fas fa-chart-bar"></i> Top Volume</div>
                        <div class="widget-status">Live</div>
                    </div>
                    <div class="widget-body" id="topVolumeList"><div class="widget-loading">Loading...</div></div>
                </div>
                <div class="feature-card widget-card">
                    <div class="widget-header">
                        <div class="widget-title"><i class="fas fa-money-bill-trend-up"></i> Top Value</div>
                        <div class="widget-status">Live</div>
                    </div>
                    <div class="widget-body" id="topTurnoverList"><div class="widget-loading">Loading...</div></div>
                </div>
            </div>

        </div>
    </div><!-- end welcomeScreen -->

    <!-- CHAT MESSAGES -->
    <div class="card-body msg_card_body" id="messageFormeight" style="display:none;"></div>

    <!-- CURRENCY PANEL -->
    <!-- CURRENCY PANEL -->
    <div id="currencyPanel" class="feature-panel">

        <!-- Header -->
        <div class="fp-header">
            <div class="fp-header-left">
                <div class="fp-icon-wrap" style="background:linear-gradient(135deg,#3b82f6,#6366f1);">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div>
                    <div class="fp-title">Currency Rates</div>
                    <div class="fp-subtitle" id="currencyMeta">Loading‚Ä¶</div>
                </div>
            </div>
            <button class="fp-refresh-btn" onclick="loadCurrency(true)" id="currencyRefreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Converter Card -->
        <div id="converterBox" class="converter-card" style="display:none;">
            <div class="converter-label"><i class="fas fa-calculator"></i> Quick Converter</div>
            <div class="converter-row">
                <div class="conv-input-wrap">
                    <input type="number" id="convAmount" value="1" min="0" step="any"
                           class="conv-input" oninput="runConvert()" placeholder="Amount">
                    <select id="convFrom" class="conv-select" onchange="runConvert()">
                        <option value="INR">üáÆüá≥ INR</option>
                    </select>
                </div>
                <button class="conv-swap-btn" onclick="swapCurrencies()" title="Swap">
                    <i class="fas fa-arrow-right-arrow-left"></i>
                </button>
                <div class="conv-input-wrap">
                    <div id="convResult" class="conv-result-display">‚Äî</div>
                    <select id="convTo" class="conv-select" onchange="runConvert()">
                        <option value="USD">üá∫üá∏ USD</option>
                    </select>
                </div>
            </div>
            <div id="convRate" class="conv-rate-hint"></div>
        </div>

        <div id="currencyContent" class="fp-content">
            <div class="fp-loading"><i class="fas fa-spinner fa-spin"></i><span>Loading rates‚Ä¶</span></div>
        </div>
    </div>

    <!-- METALS PANEL -->
    <div id="metalsPanel" class="feature-panel">

        <!-- Header -->
        <div class="fp-header">
            <div class="fp-header-left">
                <div class="fp-icon-wrap" style="background:linear-gradient(135deg,#f59e0b,#ef4444);">
                    <i class="fas fa-gem"></i>
                </div>
                <div>
                    <div class="fp-title">Gold &amp; Silver</div>
                    <div class="fp-subtitle" id="metalsLastUpdated">Live MCX Futures</div>
                </div>
            </div>
            <button class="fp-refresh-btn" onclick="loadMetals(true)" id="metalsRefreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <div id="metalsContent" class="fp-content">
            <div class="fp-loading"><i class="fas fa-spinner fa-spin"></i><span>Fetching prices‚Ä¶</span></div>
        </div>
    </div>

    <!-- MUTUAL FUND PANEL -->
    <div id="mfPanel" class="feature-panel">
        <div class="fp-header">
            <div class="fp-header-left">
                <div class="fp-icon-wrap" style="background:linear-gradient(135deg,#059669,#10b981);">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <div class="fp-title">Mutual Fund Search</div>
                    <div class="fp-subtitle">Search any Indian MF ¬∑ Live NAV &amp; Returns</div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mf-search-bar">
            <div class="mf-search-wrap">
                <i class="fas fa-search mf-search-icon"></i>
                <input type="text" id="mfSearchInput" class="mf-search-input"
                       placeholder="Search by fund name e.g. HDFC Midcap, Axis Bluechip‚Ä¶"
                       oninput="mfSearchDebounce()">
            </div>
        </div>

        <div id="mfContent" class="fp-content">
            <div class="mf-empty-state">
                <i class="fas fa-search"></i>
                <p>Search for any mutual fund above</p>
                <span>Covers all AMFI-registered funds in India</span>
            </div>
        </div>
    </div>

    <!-- GLOSSARY PANEL -->
    <div id="glossaryPanel" class="feature-panel">
        <div class="fp-header">
            <div class="fp-header-left">
                <div class="fp-icon-wrap" style="background:linear-gradient(135deg,#7c3aed,#a855f7);">
                    <i class="fas fa-book-open"></i>
                </div>
                <div>
                    <div class="fp-title">Finance Glossary</div>
                    <div class="fp-subtitle">100+ terms explained simply for beginners</div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mf-search-bar">
            <div class="mf-search-wrap">
                <i class="fas fa-search mf-search-icon"></i>
                <input type="text" id="glossarySearch" class="mf-search-input"
                       placeholder="Search a term e.g. NAV, P/E Ratio, SIP‚Ä¶"
                       oninput="filterGlossary()">
            </div>
        </div>

        <!-- Category Filter -->
        <div class="gloss-cats" id="glossaryCats"></div>

        <div id="glossaryContent" class="fp-content"></div>
    </div>


    <!-- NEWS PANEL -->
    <div id="newsPanel" style="display:none; padding:24px; overflow-y:auto; height:100%;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
            <div>
                <h5 style="margin:0; font-weight:700; color:#1e293b;">
                    <i class="fas fa-newspaper" style="color:#3b82f6; margin-right:8px;"></i>Market News
                </h5>
                <small style="color:#94a3b8;" id="newsLastUpdated"></small>
            </div>
            <button onclick="loadNews()" id="newsRefreshBtn"
                style="background:#f1f5f9; border:none; border-radius:8px; padding:6px 14px;
                       font-size:0.8rem; color:#64748b; cursor:pointer; display:flex; align-items:center; gap:6px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div id="newsContent">
            <div style="text-align:center; padding:60px 0; color:#94a3b8;">
                <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:12px; display:block;"></i>
                Loading news‚Ä¶
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="resultsContainer" class="results-container" style="display:none;">
        <div id="resultsContent"></div>
    </div>

    <!-- FORMS -->
    <div id="formsContainer" class="forms-container" style="display:none;">

        <div id="stockForm" class="input-form" style="display:none;">
    <h5><i class="fas fa-chart-line"></i> Stock Information</h5>
    
    <div class="form-group">
        <label>Search Stock Name or Ticker</label>
        <div class="search-wrapper">
            <input type="text" class="form-control" id="stockName" 
                   placeholder="Type to search (e.g. Reliance, Tata, HDFC)..." 
                   autocomplete="off">
            <div id="customStockDropdown" class="custom-dropdown"></div>
        </div>
    </div>
    
    <button class="btn btn-primary btn-block" onclick="submitStockForm()">
        <i class="fas fa-search"></i> Get Stock Info
    </button>
</div>

        <!-- EMI Form -->
        <div id="emiForm" class="input-form" style="display:none;">
            <h5><i class="fas fa-home"></i> EMI Calculator</h5>
            <div class="form-group">
                <label>Loan Amount (‚Çπ)</label>
                <input type="number" class="form-control" id="emiPrincipal" placeholder="e.g., 500000">
            </div>
            <div class="form-group">
                <label>Interest Rate (% per annum)</label>
                <input type="number" step="0.1" class="form-control" id="emiRate" placeholder="e.g., 8.5">
            </div>
            <div class="form-group">
                <label>Loan Tenure (Years)</label>
                <input type="number" class="form-control" id="emiTenure" placeholder="e.g., 5">
            </div>
            <button class="btn btn-primary btn-block" onclick="submitEMIForm()">
                <i class="fas fa-calculator"></i> Calculate EMI
            </button>
        </div>

        <!-- SIP Form -->
        <div id="sipForm" class="input-form" style="display:none;">
            <h5><i class="fas fa-coins"></i> SIP Calculator</h5>
            <div class="form-group">
                <label>Monthly Investment (‚Çπ)</label>
                <input type="number" class="form-control" id="sipAmount" placeholder="e.g., 5000">
            </div>
            <div class="form-group">
                <label>Expected Annual Return (%)</label>
                <input type="number" step="0.1" class="form-control" id="sipRate" placeholder="e.g., 12">
            </div>
            <div class="form-group">
                <label>Investment Period (Years)</label>
                <input type="number" class="form-control" id="sipTenure" placeholder="e.g., 10">
            </div>
            <button class="btn btn-primary btn-block" onclick="submitSIPForm()">
                <i class="fas fa-calculator"></i> Calculate SIP
            </button>
        </div>

        <!-- FD Form -->
        <div id="fdForm" class="input-form" style="display:none;">
            <h5><i class="fas fa-piggy-bank"></i> Fixed Deposit Calculator</h5>
            <div class="form-group">
                <label>Deposit Amount (‚Çπ)</label>
                <input type="number" class="form-control" id="fdAmount" placeholder="e.g., 100000">
            </div>
            <div class="form-group">
                <label>Interest Rate (% per annum)</label>
                <input type="number" step="0.1" class="form-control" id="fdRate" placeholder="e.g., 7">
            </div>
            <div class="form-group">
                <label>Tenure (Years)</label>
                <input type="number" class="form-control" id="fdTenure" placeholder="e.g., 2">
            </div>
            <button class="btn btn-primary btn-block" onclick="submitFDForm()">
                <i class="fas fa-calculator"></i> Calculate FD
            </button>
        </div>

        <!-- Step-up SIP Form -->
        <div id="stepsipForm" class="input-form" style="display:none;">
            <h5><i class="fas fa-chart-line"></i> Step-up SIP Calculator</h5>
            <p style="font-size:0.82rem;color:#64748b;margin-bottom:16px;">
                Step-up SIP increases your monthly investment by a fixed % every year ‚Äî giving much better returns than flat SIP.
            </p>
            <div class="form-group">
                <label>Starting Monthly Investment (‚Çπ)</label>
                <input type="number" class="form-control" id="stepSipAmount" placeholder="e.g., 5000">
            </div>
            <div class="form-group">
                <label>Annual Step-up Rate (%)</label>
                <input type="number" step="0.5" class="form-control" id="stepSipStepup" placeholder="e.g., 10">
                <small class="form-text text-muted">Increase SIP by this % every year</small>
            </div>
            <div class="form-group">
                <label>Expected Annual Return (%)</label>
                <input type="number" step="0.1" class="form-control" id="stepSipRate" placeholder="e.g., 12">
            </div>
            <div class="form-group">
                <label>Investment Period (Years)</label>
                <input type="number" class="form-control" id="stepSipTenure" placeholder="e.g., 20">
            </div>
            <button class="btn btn-primary btn-block" onclick="submitStepSIP()">
                <i class="fas fa-calculator"></i> Calculate Step-up SIP
            </button>
        </div>

        <!-- Zakat Calculator Form -->
        <div id="zakatForm" class="input-form" style="display:none;">
            <h5><i class="fas fa-star-and-crescent"></i> Zakat Calculator</h5>
            <p style="font-size:0.82rem;color:#64748b;margin-bottom:16px;line-height:1.6;">
                Zakat is 2.5% of your total net zakatable wealth held for one lunar year, if it exceeds the Nisab threshold.
            </p>

            <div style="background:#fef9c3;border:1px solid #fde68a;border-radius:10px;padding:12px 14px;margin-bottom:18px;font-size:0.8rem;color:#92400e;">
                <strong>Nisab</strong> is calculated automatically using live gold price (85g of gold standard).
                Enter 0 for any asset you don't own.
            </div>

            <div style="font-size:0.75rem;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">Cash & Bank</div>
            <div class="form-group">
                <label>Cash in Hand + Bank Balance (‚Çπ)</label>
                <input type="number" class="form-control" id="zCash" placeholder="e.g., 200000" value="0">
            </div>
            <div class="form-group">
                <label>Savings / Fixed Deposits (‚Çπ)</label>
                <input type="number" class="form-control" id="zSavings" placeholder="e.g., 100000" value="0">
            </div>

            <div style="font-size:0.75rem;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.06em;margin:16px 0 10px;">Investments</div>
            <div class="form-group">
                <label>Stocks / Shares (current market value ‚Çπ)</label>
                <input type="number" class="form-control" id="zStocks" placeholder="e.g., 150000" value="0">
            </div>
            <div class="form-group">
                <label>Mutual Funds (current value ‚Çπ)</label>
                <input type="number" class="form-control" id="zMF" placeholder="e.g., 50000" value="0">
            </div>
            <div class="form-group">
                <label>Business Inventory / Receivables (‚Çπ)</label>
                <input type="number" class="form-control" id="zBusiness" placeholder="e.g., 0" value="0">
            </div>

            <div style="font-size:0.75rem;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.06em;margin:16px 0 10px;">Gold & Silver</div>
            <div class="form-group">
                <label>Gold (grams owned)</label>
                <input type="number" step="0.01" class="form-control" id="zGoldGrams" placeholder="e.g., 50" value="0">
            </div>
            <div class="form-group">
                <label>Silver (grams owned)</label>
                <input type="number" step="0.01" class="form-control" id="zSilverGrams" placeholder="e.g., 0" value="0">
            </div>

            <div style="font-size:0.75rem;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:.06em;margin:16px 0 10px;">Liabilities (deduct)</div>
            <div class="form-group">
                <label>Loans / Debts Due Now (‚Çπ)</label>
                <input type="number" class="form-control" id="zDebts" placeholder="e.g., 50000" value="0">
            </div>

            <button class="btn btn-primary btn-block" onclick="submitZakat()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);border:none;">
                <i class="fas fa-calculator"></i> Calculate Zakat
            </button>
        </div>

    </div><!-- end formsContainer -->

    <!-- Chat Footer -->
    <div class="card-footer" id="chatFooter" style="display:none;">
        <form id="messageArea" class="input-group">
            <input type="text" id="text" name="msg" placeholder="Type your message..." autocomplete="off" class="form-control type_msg" required>
            <div class="input-group-append">
                <button type="submit" class="input-group-text send_btn"><i class="fas fa-paper-plane"></i></button>
                <button type="button" id="voiceInput" class="input-group-text voice_btn"><i class="fas fa-microphone"></i></button>
            </div>
        </form>
    </div>

</div></div></div><!-- card / chat-container / main-content -->
</div></div><!-- row / container-fluid -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<style>
/* Chat bubble styles */
#messageFormeight {
    flex:1; overflow-y:auto; padding:28px 36px;
    background:#f0f2f7; display:flex; flex-direction:column; gap:6px;
}
.msg_cotainer_send {
    background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff;
    padding:12px 18px; border-radius:18px 18px 4px 18px;
    max-width:70%; font-size:.93rem; line-height:1.55;
    font-family:'Plus Jakarta Sans',sans-serif;
    box-shadow:0 4px 14px rgba(37,99,235,.25); margin-left:auto;
    word-break:break-word; animation:msgIn .22s cubic-bezier(.34,1.56,.64,1) both;
}
.msg_cotainer {
    background:#fff; color:#0f172a;
    padding:14px 18px; border-radius:18px 18px 18px 4px;
    max-width:78%; font-size:.93rem; line-height:1.7;
    font-family:'Plus Jakarta Sans',sans-serif;
    border:1px solid #e2e6f0; box-shadow:0 2px 8px rgba(15,23,42,.06);
    margin-right:auto; word-break:break-word;
    animation:msgIn .22s cubic-bezier(.34,1.56,.64,1) both;
}
.msg_cotainer strong { color:#1e40af; font-weight:700; }
.msg_cotainer b { font-family:'JetBrains Mono',monospace; color:#0f172a; font-size:.92rem; }
#messageFormeight .d-flex { margin-bottom:8px !important; }
@keyframes msgIn { from{opacity:0;transform:translateY(10px) scale(.97)} to{opacity:1;transform:none} }

/* Chat empty state */
.chat-empty-state {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    height:100%; gap:14px; color:#64748b; text-align:center; padding:40px;
}
.chat-empty-icon {
    width:64px; height:64px;
    background:linear-gradient(135deg,rgba(37,99,235,.1),rgba(124,58,237,.1));
    border-radius:20px; display:flex; align-items:center; justify-content:center;
    font-size:1.8rem;
}
.chat-empty-state h3 { font-size:1.1rem; font-weight:700; color:#334155; margin:0; }
.chat-empty-state p  { font-size:.88rem; color:#64748b; max-width:360px; margin:0; line-height:1.6; }
.chat-suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:6px; }
.chat-suggestion-chip {
    padding:8px 14px; background:#fff; border:1.5px solid #e2e6f0;
    border-radius:20px; font-size:.82rem; font-weight:600; color:#2563eb;
    cursor:pointer; transition:all .18s;
}
.chat-suggestion-chip:hover {
    background:#eff4ff; border-color:rgba(37,99,235,.4);
    transform:translateY(-2px); box-shadow:0 4px 12px rgba(37,99,235,.15);
}

/* Ticker */
.ticker-bar{display:flex;align-items:center;gap:0;height:38px;background:#fff;border-bottom:1px solid #e2e6f0;overflow:hidden;flex-shrink:0;box-shadow:0 1px 4px rgba(15,23,42,.05)}
.ticker-label{display:flex;align-items:center;gap:5px;padding:0 14px;height:100%;background:#eff4ff;border-right:1px solid rgba(37,99,235,.2);font-size:10px;font-weight:800;letter-spacing:.9px;color:#2563eb;white-space:nowrap;flex-shrink:0}
.ticker-label i{font-size:9px}
.ticker-track-wrap{flex:1;overflow:hidden;height:100%;position:relative}
.ticker-track{display:flex;align-items:center;height:100%;white-space:nowrap}
.ticker-refresh{background:none;border:none;border-left:1px solid #e2e6f0;color:#94a3b8;width:36px;height:100%;cursor:pointer;font-size:10px;transition:color .2s;flex-shrink:0}
.ticker-refresh:hover{color:#2563eb}
.t-chip{display:inline-flex;align-items:center;gap:8px;padding:0 20px 0 16px;height:100%;border-right:1px solid #f1f4fb;cursor:default;flex-shrink:0}
.t-name{font-size:11px;font-weight:700;color:#64748b;letter-spacing:.2px}
.t-val{font-size:12px;font-weight:700;color:#0f172a;letter-spacing:-.3px}
.t-chg{font-size:10.5px;font-weight:700}
.t-up{color:#059669}.t-down{color:#dc2626}.t-flat{color:#94a3b8}
.t-sep{font-size:14px;color:#e2e6f0;padding:0 4px;flex-shrink:0}
.closed-label{background:#fef3c7!important;border-color:rgba(217,119,6,.25)!important;color:#d97706!important}
.ticker-loading{color:#94a3b8;padding:0 20px;font-size:.85rem}
@keyframes ticker-scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.t-spin{animation:t-sp .6s linear} @keyframes t-sp{100%{transform:rotate(360deg)}}

/* CSS fix: 3-column grid: col1, col2, col3(chat span 2 rows) */
.features-grid {
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto auto;
    gap:18px;
}
.chat-feature-card {
    grid-column: 3;
    grid-row: 1 / span 2;
}
/* Nifty 500 index badge in dropdown */
.d-index {
    display: block;
    font-size: 10px;
    color: #6b7280;
    margin-top: 2px;
    font-style: italic;
}
.dropdown-item .d-name { font-size: 13px; font-weight: 500; color: #1e293b; }
.dropdown-item .d-code { font-size: 11px; color: #2563eb; font-weight: 600; margin-left: 6px; }
</style>

<script>
let currentMode = 'welcome';
let stockData   = {};

fetch("{{ url_for('static', filename='stock_logos.json') }}")
    .then(r=>r.json()).then(d=>{stockData=d;}).catch(()=>{});

function getStockLogo(sym){
    const s=sym.replace('.NS','').replace('.BO','').trim().toUpperCase();
    return (stockData[s]&&stockData[s].logo)?stockData[s].logo:'';
}
function getCompanyName(sym){
    const s=sym.replace('.NS','').replace('.BO','').trim().toUpperCase();
    return (stockData[s]&&stockData[s].name)?stockData[s].name:sym;
}

// Market widgets
function fetchTopGainers(){
    const c=document.getElementById('topGainersList'); if(!c)return;
    fetch('/top_gainers').then(r=>r.json()).then(data=>{
        if(!data||!data.length){c.innerHTML='<div class="widget-placeholder"><i class="fas fa-arrow-trend-up"></i><p>No data</p></div>';return;}
        c.innerHTML='<div class="widget-list">'+data.map(item=>{
            const p=parseFloat(item.price).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            return `<div class="widget-item" onclick="showForm('stock');setTimeout(()=>$('#stockName').val('${item.symbol}'),100);">
                <div class="widget-item-left"><div class="widget-sym">${item.symbol}</div><div class="widget-price">&#8377;${p}</div></div>
                <div class="widget-item-right"><div class="widget-pct">+${parseFloat(item.pChange).toFixed(2)}%</div><div class="widget-change">+${parseFloat(item.change).toFixed(2)}</div></div>
            </div>`;
        }).join('')+'</div>';
    }).catch(()=>{c.innerHTML='<div class="widget-placeholder"><i class="fas fa-exclamation-triangle"></i><p>Error</p></div>';});
}
function fetchTopLosers(){
    const c=document.getElementById('topLosersList'); if(!c)return;
    fetch('/top_losers').then(r=>r.json()).then(data=>{
        if(!data||!data.length){c.innerHTML='<div class="widget-placeholder"><i class="fas fa-arrow-trend-down"></i><p>No data</p></div>';return;}
        c.innerHTML='<div class="widget-list">'+data.map(item=>{
            const p=parseFloat(item.price).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            return `<div class="widget-item" onclick="showForm('stock');setTimeout(()=>$('#stockName').val('${item.symbol}'),100);">
                <div class="widget-item-left"><div class="widget-sym">${item.symbol}</div><div class="widget-price">&#8377;${p}</div></div>
                <div class="widget-item-right"><div class="widget-pct" style="color:#dc2626;">${parseFloat(item.pChange).toFixed(2)}%</div><div class="widget-change" style="color:#dc2626;">${parseFloat(item.change).toFixed(2)}</div></div>
            </div>`;
        }).join('')+'</div>';
    }).catch(()=>{c.innerHTML='<div class="widget-placeholder"><i class="fas fa-exclamation-triangle"></i><p>Error</p></div>';});
}
function fetchTopVolume(){
    const c=document.getElementById('topVolumeList'); if(!c)return;
    fetch('/top_volume').then(r=>r.json()).then(data=>{
        if(!data||!data.length){c.innerHTML='<div class="widget-placeholder"><i class="fas fa-chart-bar"></i><p>No data</p></div>';return;}
        c.innerHTML='<div class="widget-list">'+data.map(item=>{
            const p=parseFloat(item.price).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            const vol=item.volume?(item.volume/1e5).toFixed(2)+'L':'‚Äî';
            return `<div class="widget-item" onclick="showForm('stock');setTimeout(()=>$('#stockName').val('${item.symbol}'),100);">
                <div class="widget-item-left"><div class="widget-sym">${item.symbol}</div><div class="widget-price">&#8377;${p}</div></div>
                <div class="widget-item-right"><div class="widget-pct" style="color:#2563eb;">${vol}</div><div class="widget-change">volume</div></div>
            </div>`;
        }).join('')+'</div>';
    }).catch(()=>{c.innerHTML='<div class="widget-placeholder"><i class="fas fa-exclamation-triangle"></i><p>Error</p></div>';});
}
function fetchTopTurnover(){
    const c=document.getElementById('topTurnoverList'); if(!c)return;
    fetch('/top_turnover').then(r=>r.json()).then(data=>{
        if(!data||!data.length){c.innerHTML='<div class="widget-placeholder"><i class="fas fa-money-bill-trend-up"></i><p>No data</p></div>';return;}
        c.innerHTML='<div class="widget-list">'+data.map(item=>{
            const p=parseFloat(item.price).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            const to=item.turnover?'&#8377;'+(item.turnover/1e7).toFixed(2)+'Cr':'‚Äî';
            return `<div class="widget-item" onclick="showForm('stock');setTimeout(()=>$('#stockName').val('${item.symbol}'),100);">
                <div class="widget-item-left"><div class="widget-sym">${item.symbol}</div><div class="widget-price">&#8377;${p}</div></div>
                <div class="widget-item-right"><div class="widget-pct" style="color:#d97706;">${to}</div><div class="widget-change">value</div></div>
            </div>`;
        }).join('')+'</div>';
    }).catch(()=>{c.innerHTML='<div class="widget-placeholder"><i class="fas fa-exclamation-triangle"></i><p>Error</p></div>';});
}
function refreshMarketWidgets(){ fetchTopGainers();fetchTopLosers();fetchTopVolume();fetchTopTurnover(); }

function showForm(formType){
    $('.input-form').hide();
    $('#formsContainer').hide();
    $('#resultsContainer').hide();
    $('#messageFormeight').hide();
    $('#welcomeScreen').hide();
    $('#newsPanel').hide();
    $('#currencyPanel').hide();
    $('#metalsPanel').hide();
    $('#mfPanel').hide();
    $('#glossaryPanel').hide();
    $('#mfCatBar').hide();
    $('#chatFooter').hide(); // Ensures it starts hidden
    $('.menu-btn').removeClass('active');
    
    // Highlight active menu item
    $('.menu-btn').each(function(){
        if(($(this).attr('onclick')||'').includes("'"+formType+"'")) $(this).addClass('active');
    });

    currentMode=formType;

    if(formType==='chat'){
        $('#messageFormeight').css({display:'flex',flexDirection:'column'});
        $('#chatFooter').show(); // Only show footer in Chat Mode
        // ... (rest of chat logic) ...
    } else if(formType==='stock'){
        $('#formsContainer').show(); 
        $('#stockForm').show(); 
        $('#chatFooter').hide(); // <--- CRITICAL CHANGE: Hide footer here
    } else if(formType==='news'){
        $('#newsPanel').show();
        loadNews();
    } else if(formType==='currency'){
        $('#currencyPanel').css('display','flex');
        loadCurrency();
    } else if(formType==='metals'){
        $('#metalsPanel').css('display','flex');
        loadMetals();
    } else if(formType==='mf'){
        $('#mfPanel').css('display','flex');
        $('#mfCatBar').show();
        setTimeout(()=>{ initMFPanel(); $('#mfSearchInput').focus(); }, 100);
    } else if(formType==='glossary'){
        $('#glossaryPanel').css('display','flex');
        initGlossary();
    } else {
        $('#formsContainer').show(); 
        $('#'+formType+'Form').show();
        // Footer remains hidden by default
    }
}
function goHome(){
    $('.input-form').hide();
    $('#formsContainer').hide();
    $('#resultsContainer').hide();
    $('#messageFormeight').hide();
    $('#chatFooter').hide();
    $('#newsPanel').hide();
    $('#currencyPanel').hide();
    $('#metalsPanel').hide();
    $('#mfPanel').hide();
    $('#glossaryPanel').hide();
    $('#mfCatBar').hide();
    $('#welcomeScreen').show();
    $('.menu-btn').removeClass('active');
    currentMode='welcome';
    refreshMarketWidgets();
}

function showResults(){
    $('#formsContainer').hide();
    $('#resultsContainer').show();
    $('#resultsContent').html('<div class="sfc-loading"><div class="sfc-spinner"></div><span>Loading‚Ä¶</span></div>');
}

function addBackButton(){
    return `<div class="button-container">
        <button class="btn btn-primary" onclick="backToForm()"><i class="fas fa-redo"></i> Calculate Again</button>
    </div>`;
}

function backToForm(){
    $('#resultsContainer').hide();
    $('#formsContainer').show();
    $(`#${currentMode}Form`).show();
}

// formatResult
function formatResult(data,type){
    let html='';
    if(type==='emi'){
        const m1=data.match(/monthly EMI will be ‚Çπ([\d,]+\.?\d*)/i);
        const m2=data.match(/Total Payment[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        const m3=data.match(/Total Interest[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        if(m1) html=`<div class="result-header"><h3><i class="fas fa-home"></i> EMI Result</h3><div class="subtitle">Loan Payment Breakdown</div></div>
            <div class="result-body">
                <div class="result-row highlight"><div class="result-label"><i class="fas fa-calendar-alt"></i> Monthly EMI</div><div class="result-value large">‚Çπ${m1[1]}</div></div>
                ${m2?`<div class="result-row"><div class="result-label"><i class="fas fa-money-bill-wave"></i> Total Payment</div><div class="result-value">‚Çπ${m2[1]}</div></div>`:''}
                ${m3?`<div class="result-row"><div class="result-label"><i class="fas fa-percentage"></i> Total Interest</div><div class="result-value">‚Çπ${m3[1]}</div></div>`:''}
            </div>`;
    } else if(type==='sip'){
        const m1=data.match(/Total Invested[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        const m2=data.match(/Maturity Value[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        const m3=data.match(/Returns Earned[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        if(m2) html=`<div class="result-header"><h3><i class="fas fa-coins"></i> SIP Result</h3><div class="subtitle">Investment Projection</div></div>
            <div class="result-body">
                ${m1?`<div class="result-row"><div class="result-label"><i class="fas fa-coins"></i> Total Invested</div><div class="result-value">‚Çπ${m1[1]}</div></div>`:''}
                <div class="result-row highlight success"><div class="result-label"><i class="fas fa-trophy"></i> Maturity Value</div><div class="result-value large success">‚Çπ${m2[1]}</div></div>
                ${m3?`<div class="result-row"><div class="result-label"><i class="fas fa-arrow-up"></i> Returns Earned</div><div class="result-value success">‚Çπ${m3[1]}</div></div>`:''}
            </div>`;
    } else if(type==='fd'){
        const m1=data.match(/maturity amount.*?is ‚Çπ([\d,]+\.?\d*)/i)||data.match(/‚Çπ([\d,]+\.?\d*)\s*(?:will be|at maturity)/i)||data.match(/(?:total|maturity)[^‚Çπ]*‚Çπ([\d,]+\.?\d*)/i);
        const m2=data.match(/interest[:\s]+‚Çπ([\d,]+\.?\d*)/i);
        if(m1) html=`<div class="result-header"><h3><i class="fas fa-piggy-bank"></i> Fixed Deposit Result</h3><div class="subtitle">Maturity Projection</div></div>
            <div class="result-body">
                <div class="result-row highlight success"><div class="result-label"><i class="fas fa-piggy-bank"></i> Maturity Amount</div><div class="result-value large success">‚Çπ${m1[1]}</div></div>
                ${m2?`<div class="result-row"><div class="result-label"><i class="fas fa-percentage"></i> Interest Earned</div><div class="result-value success">‚Çπ${m2[1]}</div></div>`:''}
            </div>`;
    }
    if(!html) html=`<div class="result-header"><h3>Result</h3></div><div class="result-body"><div class="result-row" style="padding:24px 32px;"><div style="font-size:.95rem;line-height:1.7;color:#334155;">${data}</div></div></div>`;
    return html;
}

// Stock submit
function submitStockForm(){
    const nm=$('#stockName').val();
    if(!nm){alert('Please select a stock');return;}
    showResults();
    $('#resultsContent').html('<div class="sfc-loading"><div class="sfc-spinner"></div><span>Fetching live market data‚Ä¶</span></div>');
    $.ajax({url:'/get_stock',method:'POST',data:{symbol:nm},timeout:20000})
    .done(function(d){
        if(d.error){$('#resultsContent').html('<div class="error-card">‚ùå '+d.error+'</div>');return;}
        const now=new Date(), ist=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Kolkata'}));
        const day=ist.getDay(), mins=ist.getHours()*60+ist.getMinutes();
        const isOpen=day>=1&&day<=5&&mins>=555&&mins<=930;
        const bStyle=isOpen?'background:rgba(5,150,105,.15);border:1px solid rgba(5,150,105,.35);color:#059669;':'background:rgba(220,38,38,.12);border:1px solid rgba(220,38,38,.25);color:#dc2626;';
        const bText=isOpen?'‚óè LIVE':'‚óè Market Closed';
        const sym=d.symbol||nm,up=(d.change||0)>=0,cc=up?'sfc-up':'sfc-down',ca=up?'‚ñ≤':'‚ñº';
        const wu=(d.week_change||0)>=0,wc=wu?'sfc-up':'sfc-down',wa=wu?'‚ñ≤':'‚ñº';
        const logo=getStockLogo(sym);
        const lh=logo?`<img src="${logo}" class="sfc-logo" onerror="this.outerHTML='<div class=sfc-logo-fb><i class=\\'fas fa-chart-bar\\'></i></div>'">`:`<div class="sfc-logo-fb"><i class="fas fa-chart-bar"></i></div>`;
        const co=getCompanyName(sym);
        const f=v=>v!=null?'‚Çπ'+parseFloat(v).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}):'‚Äî';
        const fc=v=>v!=null?(v>=0?'+':'')+parseFloat(v).toFixed(2):'‚Äî';
        $('#resultsContent').html(`<div class="sfc-card">
            <div class="sfc-head">${lh}<div class="sfc-head-text"><div class="sfc-company">${co}</div><div class="sfc-ticker">${sym} &middot; NSE India</div></div>
                <div style="${bStyle}font-size:.7rem;font-weight:800;letter-spacing:.1em;padding:4px 12px;border-radius:20px;flex-shrink:0;">${bText}</div>
            </div>
            <div class="sfc-hero"><div class="sfc-big-price">${f(d.current)}</div><div class="sfc-chg ${cc}">${ca} ${fc(d.change)} <span class="sfc-pct">(${fc(d.change_pct)}%)</span></div></div>
            <div class="sfc-section"><div class="sfc-section-hdr"><i class="fas fa-sun"></i> Today</div><div class="sfc-row-grid">
                <div class="sfc-stat"><div class="sfc-stat-lbl">Open</div><div class="sfc-stat-val">${f(d.open)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Prev Close</div><div class="sfc-stat-val">${f(d.prev_close)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Day High</div><div class="sfc-stat-val sfc-up">${f(d.day_high)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Day Low</div><div class="sfc-stat-val sfc-down">${f(d.day_low)}</div></div>
            </div></div>
            <div class="sfc-section sfc-section-weekly"><div class="sfc-section-hdr"><i class="fas fa-calendar-week"></i> This Week</div><div class="sfc-row-grid">
                <div class="sfc-stat"><div class="sfc-stat-lbl">Week Open</div><div class="sfc-stat-val">${f(d.week_open)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Week Close</div><div class="sfc-stat-val">${f(d.week_close)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Week High</div><div class="sfc-stat-val sfc-up">${f(d.week_high)}</div></div>
                <div class="sfc-stat"><div class="sfc-stat-lbl">Week Low</div><div class="sfc-stat-val sfc-down">${f(d.week_low)}</div></div>
            </div><div class="sfc-wk-summary ${wc}"><span><i class="fas fa-chart-line"></i> Weekly Change</span><span class="sfc-wk-val">${wa} ${fc(d.week_change)} &nbsp;(${fc(d.week_pct)}%)</span></div></div>
            <div class="sfc-footer">
                <button class="btn btn-primary" onclick="submitStockForm()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="btn btn-secondary" onclick="showForm('stock')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
        </div>`);
    }).fail(function(_,s){$('#resultsContent').html('<div class="error-card">‚ùå '+(s==='timeout'?'Request timed out.':'Failed to fetch data.')+'</div>');});
}

// Calculator submits
function submitEMIForm(){
    const principal = parseFloat($('#emiPrincipal').val());
    const annualRate = parseFloat($('#emiRate').val());
    const tenureYears = parseFloat($('#emiTenure').val());
    if(!principal||!annualRate||!tenureYears){ alert('Please fill all fields'); return; }

    const mr  = annualRate / 12 / 100;
    const n   = Math.round(tenureYears * 12);
    const emi = principal * mr * Math.pow(1 + mr, n) / (Math.pow(1 + mr, n) - 1);
    const totalPayment  = emi * n;
    const totalInterest = totalPayment - principal;
    const interestPct   = (totalInterest / principal * 100).toFixed(1);

    // Year-by-year amortisation summary
    const yearData = [];
    let balance = principal;
    for(let y = 1; y <= tenureYears; y++){
        let yearPrincipal = 0, yearInterest = 0;
        for(let m = 0; m < 12; m++){
            if(balance <= 0) break;
            const intPart = balance * mr;
            const prinPart = Math.min(emi - intPart, balance);
            yearInterest  += intPart;
            yearPrincipal += prinPart;
            balance       -= prinPart;
        }
        yearData.push({ year: y, emi: emi * Math.min(12, n - (y-1)*12),
            principal: yearPrincipal, interest: yearInterest,
            balance: Math.max(0, balance) });
    }

    const fmt  = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
    const fmtD = v => '‚Çπ' + v.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

    showResults();
    $('#resultsContent').html(`
        <div class="result-header">
            <h3><i class="fas fa-home"></i> EMI Results</h3>
        </div>
        <div class="result-body">
            <!-- EMI hero -->
            <div class="emi-hero-card">
                <div class="emi-hero-label">Monthly EMI</div>
                <div class="emi-hero-value">${fmtD(emi)}</div>
                <div class="emi-hero-sub">for ${n} months at ${annualRate}% p.a.</div>
            </div>

            <!-- Summary cards -->
            <div class="stepsip-summary">
                <div class="stepsip-card stepsip-invested">
                    <div class="stepsip-label">Loan Amount</div>
                    <div class="stepsip-val">${fmt(principal)}</div>
                </div>
                <div class="stepsip-card stepsip-maturity">
                    <div class="stepsip-label">Total Payment</div>
                    <div class="stepsip-val">${fmt(totalPayment)}</div>
                </div>
                <div class="stepsip-card stepsip-returns">
                    <div class="stepsip-label">Total Interest</div>
                    <div class="stepsip-val">${fmt(totalInterest)}</div>
                </div>
                <div class="stepsip-card stepsip-ratio">
                    <div class="stepsip-label">Interest %</div>
                    <div class="stepsip-val">${interestPct}%</div>
                </div>
            </div>

            <!-- Loan breakdown -->
            <div class="stepsip-compare">
                <div class="stepsip-compare-title"><i class="fas fa-chart-pie"></i> Loan Breakdown</div>
                <div class="stepsip-compare-row">
                    <span>Principal Amount</span>
                    <strong>${fmtD(principal)}</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Interest Rate</span>
                    <strong>${annualRate}% per annum</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Loan Tenure</span>
                    <strong>${tenureYears} years (${n} EMIs)</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Interest to Principal Ratio</span>
                    <strong style="color:#dc2626;">${(totalInterest/principal).toFixed(2)}x</strong>
                </div>
            </div>

            <!-- Progress bar: principal vs interest -->
            <div class="emi-split-bar-wrap">
                <div class="emi-split-bar-title">Principal vs Interest Split</div>
                <div class="emi-split-bar">
                    <div class="emi-split-principal" style="width:${(principal/totalPayment*100).toFixed(1)}%"></div>
                    <div class="emi-split-interest" style="width:${(totalInterest/totalPayment*100).toFixed(1)}%"></div>
                </div>
                <div class="emi-split-legend">
                    <span><span class="emi-dot emi-dot-p"></span>Principal ${(principal/totalPayment*100).toFixed(1)}%</span>
                    <span><span class="emi-dot emi-dot-i"></span>Interest ${(totalInterest/totalPayment*100).toFixed(1)}%</span>
                </div>
            </div>

            <!-- Year-by-year amortisation table -->
            <div class="stepsip-table-wrap">
                <div class="stepsip-table-title">Year-by-Year Amortisation</div>
                <table class="stepsip-table">
                    <thead>
                        <tr><th>Year</th><th>Principal Paid</th><th>Interest Paid</th><th>Balance</th></tr>
                    </thead>
                    <tbody>
                        ${yearData.map(r => `<tr>
                            <td>Y${r.year}</td>
                            <td style="color:#2563eb">${fmt(r.principal)}</td>
                            <td style="color:#dc2626">${fmt(r.interest)}</td>
                            <td>${fmt(r.balance)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="result-note">* Calculated using flat reducing balance method. Actual bank EMI may vary slightly.</div>
            ${addBackButton()}
        </div>`);
}
function submitSIPForm(){
    const monthly = parseFloat($('#sipAmount').val());
    const rate    = parseFloat($('#sipRate').val());
    const years   = parseInt($('#sipTenure').val());
    if(!monthly||!rate||!years){ alert('Please fill all fields'); return; }

    const mr  = rate / 12 / 100;
    const n   = years * 12;
    const fv  = monthly * (((1 + mr) ** n - 1) / mr) * (1 + mr);
    const inv = monthly * n;
    const ret = fv - inv;
    const retPct = (ret / inv * 100).toFixed(1);
    const wealthRatio = (fv / inv).toFixed(2);

    // Year-by-year data
    const yearData = [];
    let mv = 0;
    for(let y = 1; y <= years; y++){
        for(let m = 0; m < 12; m++) mv = (mv + monthly) * (1 + mr);
        const invested = monthly * y * 12;
        yearData.push({ year: y, invested, value: mv, gain: mv - invested });
    }

    const fmt = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
    const fmtD = v => '‚Çπ' + v.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

    showResults();
    $('#resultsContent').html(`
        <div class="result-header">
            <h3><i class="fas fa-coins"></i> SIP Results</h3>
        </div>
        <div class="result-body">
            <!-- Summary cards ‚Äî same style as Step-up SIP -->
            <div class="stepsip-summary">
                <div class="stepsip-card stepsip-invested">
                    <div class="stepsip-label">Total Invested</div>
                    <div class="stepsip-val">${fmt(inv)}</div>
                </div>
                <div class="stepsip-card stepsip-maturity">
                    <div class="stepsip-label">Maturity Value</div>
                    <div class="stepsip-val">${fmt(fv)}</div>
                </div>
                <div class="stepsip-card stepsip-returns">
                    <div class="stepsip-label">Total Returns</div>
                    <div class="stepsip-val">${fmt(ret)}</div>
                </div>
                <div class="stepsip-card stepsip-ratio">
                    <div class="stepsip-label">Wealth Ratio</div>
                    <div class="stepsip-val">${wealthRatio}x</div>
                </div>
            </div>

            <!-- Key stats strip -->
            <div class="stepsip-compare">
                <div class="stepsip-compare-title"><i class="fas fa-info-circle"></i> Summary</div>
                <div class="stepsip-compare-row">
                    <span>Monthly SIP Amount</span>
                    <strong>${fmtD(monthly)}</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Investment Period</span>
                    <strong>${years} years (${n} months)</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Expected Annual Return</span>
                    <strong>${rate}%</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Return on Investment</span>
                    <strong style="color:#16a34a;">${retPct}%</strong>
                </div>
            </div>

            <!-- Year-by-year table -->
            <div class="stepsip-table-wrap">
                <div class="stepsip-table-title">Year-by-Year Breakdown</div>
                <table class="stepsip-table">
                    <thead>
                        <tr><th>Year</th><th>Total Invested</th><th>Portfolio Value</th><th>Gain</th></tr>
                    </thead>
                    <tbody>
                        ${yearData.map(r => `<tr>
                            <td>Y${r.year}</td>
                            <td>${fmt(r.invested)}</td>
                            <td>${fmt(r.value)}</td>
                            <td style="color:${r.gain>=0?'#16a34a':'#dc2626'}">${fmt(r.gain)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="result-note">* Returns are estimated at a flat ${rate}% p.a. Actual MF returns vary with market conditions.</div>
            ${addBackButton()}
        </div>`);
}
function submitFDForm(){
    const principal  = parseFloat($('#fdAmount').val());
    const annualRate = parseFloat($('#fdRate').val());
    const years      = parseFloat($('#fdTenure').val());
    if(!principal||!annualRate||!years){ alert('Please fill all fields'); return; }

    // Compound quarterly (standard Indian bank FD compounding)
    const n         = 4;  // quarterly
    const maturity  = principal * Math.pow(1 + annualRate/(n*100), n*years);
    const interest  = maturity - principal;
    const retPct    = (interest / principal * 100).toFixed(1);
    const effectiveRate = ((maturity / principal) ** (1/years) - 1) * 100;

    // Year-by-year growth
    const yearData = [];
    for(let y = 1; y <= Math.ceil(years); y++){
        const yrs = Math.min(y, years);
        const val = principal * Math.pow(1 + annualRate/(n*100), n*yrs);
        yearData.push({ year: y, value: val, interest: val - principal });
    }

    const fmt  = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
    const fmtD = v => '‚Çπ' + v.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

    showResults();
    $('#resultsContent').html(`
        <div class="result-header">
            <h3><i class="fas fa-piggy-bank"></i> Fixed Deposit Results</h3>
        </div>
        <div class="result-body">
            <!-- FD hero -->
            <div class="fd-hero-card">
                <div class="fd-hero-label">Maturity Amount</div>
                <div class="fd-hero-value">${fmtD(maturity)}</div>
                <div class="fd-hero-sub">${fmtD(principal)} grows to this in ${years} year${years!==1?'s':''}</div>
            </div>

            <!-- Summary cards -->
            <div class="stepsip-summary">
                <div class="stepsip-card stepsip-invested">
                    <div class="stepsip-label">Principal</div>
                    <div class="stepsip-val">${fmt(principal)}</div>
                </div>
                <div class="stepsip-card stepsip-maturity">
                    <div class="stepsip-label">Maturity Value</div>
                    <div class="stepsip-val">${fmt(maturity)}</div>
                </div>
                <div class="stepsip-card stepsip-returns">
                    <div class="stepsip-label">Interest Earned</div>
                    <div class="stepsip-val">${fmt(interest)}</div>
                </div>
                <div class="stepsip-card stepsip-ratio">
                    <div class="stepsip-label">Total Return</div>
                    <div class="stepsip-val">${retPct}%</div>
                </div>
            </div>

            <!-- FD Details -->
            <div class="stepsip-compare">
                <div class="stepsip-compare-title"><i class="fas fa-info-circle"></i> FD Details</div>
                <div class="stepsip-compare-row">
                    <span>Deposit Amount</span>
                    <strong>${fmtD(principal)}</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Interest Rate</span>
                    <strong>${annualRate}% p.a.</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Tenure</span>
                    <strong>${years} year${years!==1?'s':''}</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Compounding</span>
                    <strong>Quarterly</strong>
                </div>
                <div class="stepsip-compare-row">
                    <span>Effective Annual Yield</span>
                    <strong style="color:#16a34a;">${effectiveRate.toFixed(2)}%</strong>
                </div>
            </div>

            <!-- Growth table -->
            <div class="stepsip-table-wrap">
                <div class="stepsip-table-title">Year-by-Year Growth</div>
                <table class="stepsip-table">
                    <thead>
                        <tr><th>Year</th><th>Value</th><th>Interest Earned</th></tr>
                    </thead>
                    <tbody>
                        ${yearData.map(r => `<tr>
                            <td>Y${r.year}</td>
                            <td>${fmt(r.value)}</td>
                            <td style="color:#16a34a">${fmt(r.interest)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="result-note">* Compounded quarterly as per standard Indian bank FD convention. Interest is taxable as per your income slab.</div>
            ${addBackButton()}
        </div>`);
}

function sendFormQuery(msg){
    $.ajax({data:{msg:msg},type:'POST',url:'/get',timeout:15000})
    .done(function(data){$('#resultsContent').html('<div class="result-card">'+formatResult(data,currentMode)+addBackButton()+'</div>');})
    .fail(function(){$('#resultsContent').html('<div class="error-card">‚ùå Failed to fetch data.</div>');});
}

// Chat
function sendSuggestion(text){ $('#messageFormeight').empty(); sendChatMessage(text); }

function sendChatMessage(msg){
    if(!msg||!msg.trim()) return;
    $('#messageFormeight .chat-empty-state').remove();
    $('#messageFormeight').append(`<div class="d-flex justify-content-end mb-2"><div class="msg_cotainer_send">${$('<div>').text(msg).html()}</div></div>`);
    $('#messageFormeight').scrollTop($('#messageFormeight')[0].scrollHeight);
    $.ajax({data:{msg:msg},type:'POST',url:'/get'})
    .done(function(data){
        $('#messageFormeight').append(`<div class="d-flex justify-content-start mb-2"><div class="msg_cotainer">${data}</div></div>`);
        $('#messageFormeight').scrollTop($('#messageFormeight')[0].scrollHeight);
    }).fail(function(){
        $('#messageFormeight').append(`<div class="d-flex justify-content-start mb-2"><div class="msg_cotainer" style="color:#dc2626;">Sorry, something went wrong. Please try again.</div></div>`);
    });
}

$(document).ready(function(){
    refreshMarketWidgets();
    $('#messageArea').on('submit',function(e){
        e.preventDefault();
        const txt=$('#text').val().trim();
        if(txt){ sendChatMessage(txt); $('#text').val(''); }
    });
});
// Add this inside your $(document).ready(function(){ ... });

// NOTE: Stock form submission is handled exclusively by selectStock() (dropdown click)
// and the Enter keypress handler in the $(document).ready block below.
// No 'change' event handler here to avoid double-submission race conditions.
</script>

<!-- TICKER JS -->
<script>
(function(){
    const ORDER=["NIFTY 50","SENSEX","NIFTY BANK","NIFTY IT","NIFTY AUTO","NIFTY MIDCAP 100","NIFTY SMALLCAP 100"];
    function fmtIN(n){return parseFloat(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});}
    function buildTicker(indices,isOpen){
        const track=document.getElementById('tickerTrack'), label=document.getElementById('tickerStatus');
        if(isOpen){label.textContent='LIVE';label.closest('.ticker-label').className='ticker-label';}
        else{label.textContent='LAST CLOSE';label.closest('.ticker-label').className='ticker-label closed-label';}
        if(!indices||!indices.length){track.innerHTML='<span class="ticker-loading">Market data unavailable</span>';return;}
        indices.sort((a,b)=>{const ai=ORDER.indexOf(a.name),bi=ORDER.indexOf(b.name);return(ai<0?99:ai)-(bi<0?99:bi);});
        function chips(){return indices.map(idx=>{
            const up=idx.change>0.005,dn=idx.change<-0.005,cls=up?'t-up':dn?'t-down':'t-flat',arr=up?'‚ñ≤':dn?'‚ñº':'‚ñ¨',sign=up?'+':'';
            return `<span class="t-chip"><span class="t-name">${idx.name}</span><span class="t-val">${fmtIN(idx.value)}</span><span class="t-chg ${cls}">${arr} ${sign}${parseFloat(idx.pct).toFixed(2)}%</span></span>`;
        }).join('<span class="t-sep">¬∑</span>');}
        const c=chips();
        track.innerHTML=c+'<span class="t-sep" style="padding:0 24px"></span>'+c;
        requestAnimationFrame(()=>{const dur=Math.max(20,track.scrollWidth/2/60);track.style.animation=`ticker-scroll ${dur}s linear infinite`;});
    }
    window.fetchTicker=function(){
        const ic=document.getElementById('tickerRefreshIcon');
        if(ic){ic.classList.add('t-spin');setTimeout(()=>ic.classList.remove('t-spin'),600);}
        fetch('/market').then(r=>r.json()).then(d=>buildTicker(d.indices||[],d.market_open))
            .catch(()=>{const t=document.getElementById('tickerTrack');if(t)t.innerHTML='<span class="ticker-loading">Error loading data</span>';});
    };
    const _sf=window.showForm;
    window.showForm=function(f){_sf(f);const tb=document.getElementById('tickerBar');if(tb)tb.style.display='none';};
    const _gh=window.goHome;
    window.goHome=function(){_gh();const tb=document.getElementById('tickerBar');if(tb)tb.style.display='flex';};
    fetchTicker();
    setInterval(fetchTicker,60000);
})();
const STOCK_MASTER_LIST = [
    {v:"ADANIENT", l:"Adani Enterprises Ltd.", i:"Nifty 50"},
    {v:"ADANIPORTS", l:"Adani Ports & SEZ Ltd.", i:"Nifty 50"},
    {v:"APOLLOHOSP", l:"Apollo Hospitals Enterprise Ltd.", i:"Nifty 50"},
    {v:"ASIANPAINT", l:"Asian Paints Ltd.", i:"Nifty 50"},
    {v:"AXISBANK", l:"Axis Bank Ltd.", i:"Nifty 50"},
    {v:"BAJAJ-AUTO", l:"Bajaj Auto Ltd.", i:"Nifty 50"},
    {v:"BAJFINANCE", l:"Bajaj Finance Ltd.", i:"Nifty 50"},
    {v:"BAJAJFINSV", l:"Bajaj Finserv Ltd.", i:"Nifty 50"},
    {v:"BEL", l:"Bharat Electronics Ltd.", i:"Nifty 50"},
    {v:"BPCL", l:"Bharat Petroleum Corporation Ltd.", i:"Nifty 50"},
    {v:"BHARTIARTL", l:"Bharti Airtel Ltd.", i:"Nifty 50"},
    {v:"BRITANNIA", l:"Britannia Industries Ltd.", i:"Nifty 50"},
    {v:"CIPLA", l:"Cipla Ltd.", i:"Nifty 50"},
    {v:"COALINDIA", l:"Coal India Ltd.", i:"Nifty 50"},
    {v:"DRREDDY", l:"Dr. Reddy\'s Laboratories Ltd.", i:"Nifty 50"},
    {v:"EICHERMOT", l:"Eicher Motors Ltd.", i:"Nifty 50"},
    {v:"GRASIM", l:"Grasim Industries Ltd.", i:"Nifty 50"},
    {v:"HCLTECH", l:"HCL Technologies Ltd.", i:"Nifty 50"},
    {v:"HDFCBANK", l:"HDFC Bank Ltd.", i:"Nifty 50"},
    {v:"HDFCLIFE", l:"HDFC Life Insurance Co. Ltd.", i:"Nifty 50"},
    {v:"HEROMOTOCO", l:"Hero MotoCorp Ltd.", i:"Nifty 50"},
    {v:"HINDALCO", l:"Hindalco Industries Ltd.", i:"Nifty 50"},
    {v:"HINDUNILVR", l:"Hindustan Unilever Ltd.", i:"Nifty 50"},
    {v:"ICICIBANK", l:"ICICI Bank Ltd.", i:"Nifty 50"},
    {v:"ITC", l:"ITC Ltd.", i:"Nifty 50"},
    {v:"INDUSINDBK", l:"IndusInd Bank Ltd.", i:"Nifty 50"},
    {v:"INFY", l:"Infosys Ltd.", i:"Nifty 50"},
    {v:"JSWSTEEL", l:"JSW Steel Ltd.", i:"Nifty 50"},
    {v:"KOTAKBANK", l:"Kotak Mahindra Bank Ltd.", i:"Nifty 50"},
    {v:"LTIM", l:"LTIMindtree Ltd.", i:"Nifty 50"},
    {v:"LT", l:"Larsen & Toubro Ltd.", i:"Nifty 50"},
    {v:"M&M", l:"Mahindra & Mahindra Ltd.", i:"Nifty 50"},
    {v:"MARUTI", l:"Maruti Suzuki India Ltd.", i:"Nifty 50"},
    {v:"NTPC", l:"NTPC Ltd.", i:"Nifty 50"},
    {v:"NESTLEIND", l:"Nestle India Ltd.", i:"Nifty 50"},
    {v:"ONGC", l:"Oil & Natural Gas Corporation Ltd.", i:"Nifty 50"},
    {v:"POWERGRID", l:"Power Grid Corporation of India Ltd.", i:"Nifty 50"},
    {v:"RELIANCE", l:"Reliance Industries Ltd.", i:"Nifty 50"},
    {v:"SBILIFE", l:"SBI Life Insurance Co. Ltd.", i:"Nifty 50"},
    {v:"SHREECEM", l:"Shree Cement Ltd.", i:"Nifty 50"},
    {v:"SBIN", l:"State Bank of India", i:"Nifty 50"},
    {v:"SUNPHARMA", l:"Sun Pharmaceutical Industries Ltd.", i:"Nifty 50"},
    {v:"TCS", l:"Tata Consultancy Services Ltd.", i:"Nifty 50"},
    {v:"TATACONSUM", l:"Tata Consumer Products Ltd.", i:"Nifty 50"},
    {v:"TATAMOTORS", l:"Tata Motors Ltd.", i:"Nifty 50"},
    {v:"TATASTEEL", l:"Tata Steel Ltd.", i:"Nifty 50"},
    {v:"TECHM", l:"Tech Mahindra Ltd.", i:"Nifty 50"},
    {v:"TITAN", l:"Titan Company Ltd.", i:"Nifty 50"},
    {v:"ULTRACEMCO", l:"UltraTech Cement Ltd.", i:"Nifty 50"},
    {v:"WIPRO", l:"Wipro Ltd.", i:"Nifty 50"},
    {v:"ABB", l:"ABB India Ltd.", i:"Nifty Next 50"},
    {v:"AUBANK", l:"AU Small Finance Bank Ltd.", i:"Nifty Next 50"},
    {v:"ADANIENSOL", l:"Adani Energy Solutions Ltd.", i:"Nifty Next 50"},
    {v:"ADANIGREEN", l:"Adani Green Energy Ltd.", i:"Nifty Next 50"},
    {v:"ADANIPOWER", l:"Adani Power Ltd.", i:"Nifty Next 50"},
    {v:"ATGL", l:"Adani Total Gas Ltd.", i:"Nifty Next 50"},
    {v:"AMBUJACEM", l:"Ambuja Cements Ltd.", i:"Nifty Next 50"},
    {v:"DMART", l:"Avenue Supermarts Ltd.", i:"Nifty Next 50"},
    {v:"BANKBARODA", l:"Bank of Baroda", i:"Nifty Next 50"},
    {v:"BERGEPAINT", l:"Berger Paints India Ltd.", i:"Nifty Next 50"},
    {v:"CHOLAFIN", l:"Cholamandalam Investment & Finance Co. Ltd.", i:"Nifty Next 50"},
    {v:"COLPAL", l:"Colgate-Palmolive (India) Ltd.", i:"Nifty Next 50"},
    {v:"DLF", l:"DLF Ltd.", i:"Nifty Next 50"},
    {v:"DABUR", l:"Dabur India Ltd.", i:"Nifty Next 50"},
    {v:"DIVISLAB", l:"Divi\'s Laboratories Ltd.", i:"Nifty Next 50"},
    {v:"GAIL", l:"GAIL (India) Ltd.", i:"Nifty Next 50"},
    {v:"GODREJCP", l:"Godrej Consumer Products Ltd.", i:"Nifty Next 50"},
    {v:"GODREJPROP", l:"Godrej Properties Ltd.", i:"Nifty Next 50"},
    {v:"HAVELLS", l:"Havells India Ltd.", i:"Nifty Next 50"},
    {v:"HAL", l:"Hindustan Aeronautics Ltd.", i:"Nifty Next 50"},
    {v:"ICICIGI", l:"ICICI Lombard General Insurance Co. Ltd.", i:"Nifty Next 50"},
    {v:"ICICIPRULI", l:"ICICI Prudential Life Insurance Co. Ltd.", i:"Nifty Next 50"},
    {v:"NAUKRI", l:"Info Edge (India) Ltd.", i:"Nifty Next 50"},
    {v:"INDIGO", l:"InterGlobe Aviation Ltd.", i:"Nifty Next 50"},
    {v:"JINDALSTEL", l:"Jindal Steel & Power Ltd.", i:"Nifty Next 50"},
    {v:"JIOFIN", l:"Jio Financial Services Ltd.", i:"Nifty Next 50"},
    {v:"LUPIN", l:"Lupin Ltd.", i:"Nifty Next 50"},
    {v:"LODHA", l:"Macrotech Developers Ltd.", i:"Nifty Next 50"},
    {v:"MANKIND", l:"Mankind Pharma Ltd.", i:"Nifty Next 50"},
    {v:"MARICO", l:"Marico Ltd.", i:"Nifty Next 50"},
    {v:"MAXHEALTH", l:"Max Healthcare Institute Ltd.", i:"Nifty Next 50"},
    {v:"MUTHOOTFIN", l:"Muthoot Finance Ltd.", i:"Nifty Next 50"},
    {v:"NMDC", l:"NMDC Ltd.", i:"Nifty Next 50"},
    {v:"OFSS", l:"Oracle Financial Services Software Ltd.", i:"Nifty Next 50"},
    {v:"PIDILITIND", l:"Pidilite Industries Ltd.", i:"Nifty Next 50"},
    {v:"POLYCAB", l:"Polycab India Ltd.", i:"Nifty Next 50"},
    {v:"PFC", l:"Power Finance Corporation Ltd.", i:"Nifty Next 50"},
    {v:"REC", l:"REC Ltd.", i:"Nifty Next 50"},
    {v:"SRF", l:"SRF Ltd.", i:"Nifty Next 50"},
    {v:"MOTHERSON", l:"Samvardhana Motherson International Ltd.", i:"Nifty Next 50"},
    {v:"SHRIRAMFIN", l:"Shriram Finance Ltd.", i:"Nifty Next 50"},
    {v:"SIEMENS", l:"Siemens Ltd.", i:"Nifty Next 50"},
    {v:"TVSMOTOR", l:"TVS Motor Company Ltd.", i:"Nifty Next 50"},
    {v:"TATAPOWER", l:"Tata Power Company Ltd.", i:"Nifty Next 50"},
    {v:"TORNTPHARM", l:"Torrent Pharmaceuticals Ltd.", i:"Nifty Next 50"},
    {v:"TRENT", l:"Trent Ltd.", i:"Nifty Next 50"},
    {v:"UPL", l:"UPL Ltd.", i:"Nifty Next 50"},
    {v:"MCDOWELL-N", l:"United Spirits Ltd.", i:"Nifty Next 50"},
    {v:"VBL", l:"Varun Beverages Ltd.", i:"Nifty Next 50"},
    {v:"ZOMATO", l:"Zomato Ltd.", i:"Nifty Next 50"}
];
$(document).ready(function(){
    const $input    = $('#stockName');
    const $dropdown = $('#customStockDropdown');

    // ‚îÄ‚îÄ 1. Filter and show dropdown on typing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $input.on('input focus', function(){
        const val = $(this).val().toLowerCase().trim();
        if(!val){ $dropdown.hide(); return; }

        const matches = STOCK_MASTER_LIST.filter(s =>
            s.l.toLowerCase().includes(val) ||
            s.v.toLowerCase().includes(val)  ||
            (s.i && s.i.toLowerCase().includes(val))
        ).slice(0, 15); // show up to 15 results

        if(matches.length > 0){
            const html = matches.map(s => {
                const badge = s.i ? `<span class="d-index">${s.i}</span>` : '';
                return `<div class="dropdown-item" data-ticker="${s.v}">
                    <span class="d-name">${s.l}</span>
                    <span class="d-code">${s.v}</span>
                    ${badge}
                </div>`;
            }).join('');
            $dropdown.html(html).show();
        } else {
            $dropdown.hide();
        }
    });

    // ‚îÄ‚îÄ 2. Handle dropdown item click via event delegation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // mousedown fires before blur, preventing the dropdown from hiding too early
    $dropdown.on('mousedown', '.dropdown-item', function(e){
        e.preventDefault();
        const ticker = $(this).data('ticker');
        $input.val(ticker);
        $dropdown.hide();
        submitStockForm();
    });

    // ‚îÄ‚îÄ 3. Hide dropdown when clicking outside ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $(document).on('click', function(e){
        if(!$(e.target).closest('.search-wrapper').length){
            $dropdown.hide();
        }
    });

    // ‚îÄ‚îÄ 4. Enter key submits (single handler) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $input.on('keydown', function(e){
        if(e.which === 13){
            e.preventDefault();
            $dropdown.hide();
            submitStockForm();
        }
    });
});

// Kept for backward compatibility (widget onclick calls)
function selectStock(ticker, name) {
    $('#stockName').val(ticker);
    $('#customStockDropdown').hide();
    submitStockForm();
}
// ‚îÄ‚îÄ Market News ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let newsLoaded = false;

// Source display names + icons
const SOURCE_META = {
    'Economic Times': { icon: 'ET',  short: 'ET Markets'   },
    'Mint':           { icon: 'M',   short: 'Mint'          },
    'Business Standard': { icon: 'BS', short: 'BS Markets'  },
    'Financial Express': { icon: 'FE', short: 'FinExpress'  },
    'MoneyControl':   { icon: 'MC',  short: 'MoneyControl'  },
    'NDTV Profit':    { icon: 'NP',  short: 'NDTV Profit'   },
    'Reuters':        { icon: 'R',   short: 'Reuters'       },
};

function loadNews(force) {
    if (newsLoaded && !force) return;
    const $content = $('#newsContent');
    const $btn = $('#newsRefreshBtn');

    $btn.html('<i class="fas fa-spinner fa-spin"></i> Loading‚Ä¶').prop('disabled', true);
    $content.html(`
        <div style="display:flex;flex-direction:column;gap:10px;">
            ${Array(8).fill().map(()=>`
            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:16px 18px;animation:pulse 1.5s infinite;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <div style="width:42px;height:20px;background:#e2e8f0;border-radius:20px;"></div>
                    <div style="width:60px;height:14px;background:#f1f5f9;border-radius:4px;"></div>
                </div>
                <div style="height:15px;background:#e2e8f0;border-radius:4px;width:90%;margin-bottom:6px;"></div>
                <div style="height:13px;background:#f1f5f9;border-radius:4px;width:65%;"></div>
            </div>`).join('')}
        </div>`);

    $.getJSON('/news')
        .done(function(articles) {
            if (!articles || articles.length === 0) {
                $content.html('<div style="text-align:center;padding:60px 0;color:#94a3b8;"><i class="fas fa-satellite-dish" style="font-size:2.5rem;display:block;margin-bottom:14px;"></i><p style="font-weight:600;color:#64748b;margin:0 0 6px;">No fresh news found</p><span>Check back in a few minutes</span></div>');
                return;
            }

            // Group by source for source summary
            const sourceCount = {};
            articles.forEach(a => { sourceCount[a.source] = (sourceCount[a.source]||0)+1; });
            const sourceList = Object.entries(sourceCount)
                .map(([s,c]) => `<span class="news-src-chip" style="border-color:${articles.find(a=>a.source===s)?.color||'#94a3b8'};color:${articles.find(a=>a.source===s)?.color||'#64748b'}">${s} <strong>${c}</strong></span>`)
                .join('');

            const html = articles.map((a, i) => {
                const time = a.published ? formatNewsTime(a.published) : '';
                const color = a.color || '#64748b';
                const sm = SOURCE_META[a.source] || { short: a.source };
                return `
                <a href="${a.link}" target="_blank" rel="noopener noreferrer" class="news-card-link">
                    <div class="news-card" style="animation-delay:${Math.min(i,15) * 30}ms; --src-color:${color};">
                        <div class="news-card-meta">
                            <span class="news-source" style="background:${color}18;color:${color};border:1px solid ${color}33;">
                                ${sm.short}
                            </span>
                            ${time ? `<span class="news-time"><i class="far fa-clock"></i>${time}</span>` : ''}
                        </div>
                        <div class="news-title">${a.title}</div>
                        <div class="news-read-more">Read more <i class="fas fa-arrow-right"></i></div>
                    </div>
                </a>`;
            }).join('');

            $content.html(`
                <div class="news-sources-bar">${sourceList}</div>
                <div style="display:flex;flex-direction:column;gap:8px;">${html}</div>
                <div class="news-footer-note"><i class="fas fa-check-circle"></i> ${articles.length} articles ¬∑ Last 24 hours ¬∑ Finance & Markets only</div>
            `);
            newsLoaded = true;
            $('#newsLastUpdated').text('Updated ' + new Date().toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'}));
        })
        .fail(function() {
            $content.html('<div style="text-align:center;padding:60px 0;color:#ef4444;"><i class="fas fa-wifi" style="font-size:2rem;display:block;margin-bottom:12px;"></i>Could not fetch news. Check your connection.</div>');
        })
        .always(function() {
            $btn.html('<i class="fas fa-sync-alt"></i> Refresh').prop('disabled', false);
            newsLoaded = true;
        });
}

function formatNewsTime(published) {
    try {
        const d = new Date(published);
        if (isNaN(d)) return '';
        const diff = Math.floor((Date.now() - d) / 60000);
        if (diff < 1)    return 'Just now';
        if (diff < 60)   return diff + 'm ago';
        if (diff < 1440) return Math.floor(diff/60) + 'h ago';
        return Math.floor(diff/1440) + 'd ago';
    } catch(e) { return ''; }
}

// ‚îÄ‚îÄ Currency Rates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currencyData = null;

function loadCurrency(force) {
    if (currencyData && !force) { renderCurrency(currencyData); return; }
    const $btn = $('#currencyRefreshBtn');
    $btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
    $('#currencyContent').html('<div style="text-align:center;padding:40px 0;color:#94a3b8;"><i class="fas fa-spinner fa-spin" style="font-size:2rem;display:block;margin-bottom:12px;"></i>Loading rates‚Ä¶</div>');
    $.getJSON('/currency')
        .done(function(d) {
            if (d.error) { $('#currencyContent').html('<div style="color:#ef4444;text-align:center;padding:40px;">Error: '+d.error+'</div>'); return; }
            currencyData = d;
            renderCurrency(d);
            $('#currencyMeta').text('ECB data ¬∑ ' + (d.date || '') + ' ¬∑ Updated ' + new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}));
        })
        .fail(function() { $('#currencyContent').html('<div style="color:#ef4444;text-align:center;padding:40px;"><i class="fas fa-wifi" style="display:block;font-size:2rem;margin-bottom:12px;"></i>Could not fetch rates.</div>'); })
        .always(function() { $btn.html('<i class="fas fa-sync-alt"></i> Refresh').prop('disabled', false); });
}

function renderCurrency(d) {
    const $from = $('#convFrom'), $to = $('#convTo');
    $from.html('<option value="INR">üáÆüá≥ INR</option>');
    $to.html('<option value="INR">üáÆüá≥ INR</option>');
    d.rates.forEach(function(r) {
        $from.append(`<option value="${r.code}">${r.flag} ${r.code}</option>`);
        $to.append(`<option value="${r.code}">${r.flag} ${r.code}</option>`);
    });
    $to.val('USD');
    $('#converterBox').show();
    runConvert();

    const html = d.rates.map(function(r) {
        return `<div class="rate-card" onclick="$('#convTo').val('${r.code}'); $('#convFrom').val('INR'); runConvert();" title="Click to convert INR ‚Üí ${r.code}">
            <div class="rate-card-header">
                <span class="rate-flag-lg">${r.flag}</span>
                <div class="rate-badge">${r.code}</div>
            </div>
            <div class="rate-inr-value">‚Çπ${r.inr_per_unit.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
            <div class="rate-name-label">${r.name}</div>
            <div class="rate-inverse">1 ‚Çπ = ${r.unit_per_inr.toFixed(4)} ${r.code}</div>
        </div>`;
    }).join('');
    $('#currencyContent').html(`<div class="rates-grid">${html}</div>
        <div class="fp-source-note"><i class="fas fa-info-circle"></i> Source: European Central Bank via Frankfurter ¬∑ ${d.date || ''}</div>`);
}

function swapCurrencies() {
    const from = $('#convFrom').val(), to = $('#convTo').val();
    $('#convFrom').val(to); $('#convTo').val(from);
    runConvert();
}

function runConvert() {
    if (!currencyData) return;
    const amt  = parseFloat($('#convAmount').val()) || 0;
    const from = $('#convFrom').val();
    const to   = $('#convTo').val();
    const rates = { INR: 1 };
    currencyData.rates.forEach(r => { rates[r.code] = r.inr_per_unit; });
    if (!rates[from] || !rates[to]) return;
    const result = (amt * rates[from]) / rates[to];
    const fmt = result >= 0.01
        ? result.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:4})
        : result.toFixed(6);
    $('#convResult').text(fmt);
    // Show unit rate hint
    const unitResult = rates[from] / rates[to];
    const unitFmt = unitResult >= 0.01 ? unitResult.toFixed(4) : unitResult.toFixed(6);
    $('#convRate').html(`1 ${from} = <strong>${unitFmt} ${to}</strong>`);
}

// ‚îÄ‚îÄ Gold & Silver ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let metalsLoaded = false;

function loadMetals(force) {
    if (metalsLoaded && !force) return;
    const $btn = $('#metalsRefreshBtn');
    $btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
    $('#metalsContent').html('<div style="text-align:center;padding:40px 0;color:#94a3b8;"><i class="fas fa-spinner fa-spin" style="font-size:2rem;display:block;margin-bottom:12px;"></i>Fetching prices‚Ä¶</div>');
    $.getJSON('/metals')
        .done(function(d) {
            if (d.error) { $('#metalsContent').html('<div style="color:#ef4444;text-align:center;padding:40px;">Error: '+d.error+'</div>'); return; }
            renderMetals(d);
            metalsLoaded = true;
            $('#metalsLastUpdated').text('MCX Futures ¬∑ USD/INR: ‚Çπ' + d.usd_inr + ' ¬∑ ' + new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}));
        })
        .fail(function() { $('#metalsContent').html('<div style="color:#ef4444;text-align:center;padding:40px;"><i class="fas fa-wifi" style="display:block;font-size:2rem;margin-bottom:12px;"></i>Could not fetch prices.</div>'); })
        .always(function() { $btn.html('<i class="fas fa-sync-alt"></i> Refresh').prop('disabled', false); });
}

function renderMetals(d) {
    function metalCard(m, cfg) {
        if (!m) return `<div class="metal-card ${cfg.cls}"><div style="color:#94a3b8;text-align:center;padding:40px;">Data unavailable</div></div>`;
        const up    = m.change >= 0;
        const arrow = up ? '‚ñ≤' : '‚ñº';
        const chgCls = up ? 'chg-up' : 'chg-down';
        return `<div class="metal-card ${cfg.cls}">
            <div class="metal-top-row">
                <div class="metal-icon-circle" style="background:${cfg.iconBg};">${cfg.emoji}</div>
                <div class="metal-top-info">
                    <div class="metal-name">${m.name}</div>
                    <div class="metal-unit">${m.unit}</div>
                </div>
                <div class="metal-intl">
                    <div class="metal-intl-label">International</div>
                    <div class="metal-intl-val">$${m.price_usd_oz.toLocaleString('en-US',{minimumFractionDigits:2})}<span>/oz</span></div>
                </div>
            </div>
            <div class="metal-divider"></div>
            <div class="metal-price-row">
                <div>
                    <div class="metal-price-label">Current Price</div>
                    <div class="metal-price">‚Çπ${m.price_inr.toLocaleString('en-IN',{minimumFractionDigits:2})}</div>
                </div>
                <div class="${chgCls} metal-chg-box">
                    <div class="metal-chg-arrow">${arrow}</div>
                    <div>
                        <div class="metal-chg-val">‚Çπ${Math.abs(m.change).toLocaleString('en-IN',{minimumFractionDigits:2})}</div>
                        <div class="metal-chg-pct">${Math.abs(m.change_pct).toFixed(2)}%</div>
                    </div>
                </div>
            </div>
            <div class="metal-prev-row">
                <span>Prev Close</span><strong>‚Çπ${m.prev_inr.toLocaleString('en-IN',{minimumFractionDigits:2})}</strong>
            </div>
        </div>`;
    }

    const goldCfg   = { cls:'metal-gold',   emoji:'ü•á', iconBg:'linear-gradient(135deg,#f59e0b,#d97706)' };
    const silverCfg = { cls:'metal-silver', emoji:'ü•à', iconBg:'linear-gradient(135deg,#94a3b8,#475569)' };

    const html = `
        <div class="metals-grid">
            ${metalCard(d.gold,   goldCfg)}
            ${metalCard(d.silver, silverCfg)}
        </div>
        <div class="metal-usd-row">
            <i class="fas fa-dollar-sign"></i> USD/INR Rate Used: <strong>‚Çπ${d.usd_inr}</strong>
        </div>
        <div class="fp-source-note"><i class="fas fa-info-circle"></i> Gold per 10g ¬∑ Silver per kg ¬∑ MCX Futures (GC=F, SI=F) ¬∑ Prices exclude GST &amp; making charges</div>`;
    $('#metalsContent').html(html);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP-UP SIP CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitStepSIP() {
    const monthly  = parseFloat($('#stepSipAmount').val());
    const stepup   = parseFloat($('#stepSipStepup').val());
    const rate     = parseFloat($('#stepSipRate').val());
    const years    = parseInt($('#stepSipTenure').val());

    if (!monthly || !stepup || !rate || !years) {
        alert('Please fill all fields'); return;
    }

    const monthlyRate = rate / 12 / 100;
    let totalInvested = 0, maturityValue = 0;
    let currentSIP = monthly;
    const yearData = [];

    for (let y = 1; y <= years; y++) {
        let yearInvested = 0, yearEnd = maturityValue;
        for (let m = 1; m <= 12; m++) {
            yearInvested += currentSIP;
            yearEnd = (yearEnd + currentSIP) * (1 + monthlyRate);
        }
        totalInvested += yearInvested;
        maturityValue = yearEnd;
        yearData.push({ year: y, sip: currentSIP, invested: totalInvested, value: maturityValue });
        currentSIP = currentSIP * (1 + stepup / 100);
    }

    const totalReturns = maturityValue - totalInvested;
    const wealthRatio  = (maturityValue / totalInvested).toFixed(2);

    // Compare with flat SIP at same starting amount
    const flatMonthlyRate = rate / 12 / 100;
    const flatN = years * 12;
    const flatMV = monthly * (((1 + flatMonthlyRate) ** flatN - 1) / flatMonthlyRate) * (1 + flatMonthlyRate);
    const flatInvested = monthly * flatN;
    const extraGain = maturityValue - flatMV;

    showResults();
    $('#resultsContent').html(`
        <div class="result-header">
            <h3><i class="fas fa-chart-line"></i> Step-up SIP Results</h3>
        </div>
        <div class="result-body">
            <!-- Summary Cards -->
            <div class="stepsip-summary">
                <div class="stepsip-card stepsip-invested">
                    <div class="stepsip-label">Total Invested</div>
                    <div class="stepsip-val">‚Çπ${totalInvested.toLocaleString('en-IN',{maximumFractionDigits:0})}</div>
                </div>
                <div class="stepsip-card stepsip-maturity">
                    <div class="stepsip-label">Maturity Value</div>
                    <div class="stepsip-val">‚Çπ${maturityValue.toLocaleString('en-IN',{maximumFractionDigits:0})}</div>
                </div>
                <div class="stepsip-card stepsip-returns">
                    <div class="stepsip-label">Total Returns</div>
                    <div class="stepsip-val">‚Çπ${totalReturns.toLocaleString('en-IN',{maximumFractionDigits:0})}</div>
                </div>
                <div class="stepsip-card stepsip-ratio">
                    <div class="stepsip-label">Wealth Ratio</div>
                    <div class="stepsip-val">${wealthRatio}x</div>
                </div>
            </div>

            <!-- vs Flat SIP comparison -->
            <div class="stepsip-compare">
                <div class="stepsip-compare-title"><i class="fas fa-balance-scale"></i> vs Flat SIP (‚Çπ${monthly.toLocaleString('en-IN')} every month)</div>
                <div class="stepsip-compare-row">
                    <span>Flat SIP Maturity</span>
                    <strong>‚Çπ${flatMV.toLocaleString('en-IN',{maximumFractionDigits:0})}</strong>
                </div>
                <div class="stepsip-compare-row stepsip-extra">
                    <span>Extra gain with Step-up</span>
                    <strong style="color:#16a34a;">+‚Çπ${extraGain.toLocaleString('en-IN',{maximumFractionDigits:0})}</strong>
                </div>
            </div>

            <!-- Year-by-year table -->
            <div class="stepsip-table-wrap">
                <div class="stepsip-table-title">Year-by-Year Breakdown</div>
                <table class="stepsip-table">
                    <thead><tr><th>Year</th><th>Monthly SIP</th><th>Total Invested</th><th>Portfolio Value</th><th>Gain</th></tr></thead>
                    <tbody>
                        ${yearData.map(r => `<tr>
                            <td>Y${r.year}</td>
                            <td>‚Çπ${r.sip.toLocaleString('en-IN',{maximumFractionDigits:0})}</td>
                            <td>‚Çπ${r.invested.toLocaleString('en-IN',{maximumFractionDigits:0})}</td>
                            <td>‚Çπ${r.value.toLocaleString('en-IN',{maximumFractionDigits:0})}</td>
                            <td style="color:${r.value>r.invested?'#16a34a':'#dc2626'}">‚Çπ${(r.value-r.invested).toLocaleString('en-IN',{maximumFractionDigits:0})}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>

            <div class="result-note">* Returns are estimated. Actual MF returns vary with market conditions.</div>
            ${addBackButton()}
        </div>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUTUAL FUND SEARCH  ‚Äî client-side search on full cached fund list
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mfAllFunds      = [];       // full list loaded once
let mfFundsLoaded   = false;
let mfSearchTimer   = null;
let mfActiveCat     = 'All';
let MF_CATEGORIES   = ['All']; // built dynamically from API data

function mfSearchDebounce() {
    clearTimeout(mfSearchTimer);
    mfSearchTimer = setTimeout(runMFSearch, 250);
}

function initMFPanel() {
    if (mfFundsLoaded) { renderMFCats(); renderMFResults(); return; }
    $('#mfContent').html('<div class="fp-loading"><i class="fas fa-spinner fa-spin"></i><span>Loading fund database‚Ä¶</span></div>');
    $.getJSON('/mf_list')
        .done(function(d) {
            if (d.error) { $('#mfContent').html('<div class="mf-error">'+d.error+'</div>'); return; }
            mfAllFunds    = d.funds || [];
            mfFundsLoaded = true;
            renderMFCats();
            renderMFResults();
        })
        .fail(function() { $('#mfContent').html('<div class="mf-error"><i class="fas fa-wifi"></i> Could not load fund list.</div>'); });
}

function renderMFCats() {
    // Build categories dynamically from actual fund data
    const counts = {};
    mfAllFunds.forEach(f => { counts[f.cat] = (counts[f.cat]||0)+1; });

    // Sort categories alphabetically, All first
    const sorted = Object.keys(counts).sort();
    MF_CATEGORIES = ['All', ...sorted];

    const pills = MF_CATEGORIES.map(c => {
        const cnt = c==='All' ? mfAllFunds.length : (counts[c]||0);
        return `<button class="mf-cat-btn ${c===mfActiveCat?'active':''}"
            onclick="setMFCat('${c}')">${c} <span class="mf-cat-count">${cnt.toLocaleString('en-IN')}</span></button>`;
    }).join('');

    if (!$('#mfCatBar').length) {
        $('#mfContent').before(`<div id="mfCatBar" class="mf-cat-bar">${pills}</div>`);
    } else {
        $('#mfCatBar').html(pills);
    }
}

function setMFCat(cat) {
    mfActiveCat = cat;
    renderMFCats();
    runMFSearch();
}

function runMFSearch() {
    if (!mfFundsLoaded) return;
    const raw = $('#mfSearchInput').val().trim().toLowerCase();
    const words = raw.split(/\s+/).filter(Boolean);

    // Filter by category first
    let pool = mfActiveCat === 'All' ? mfAllFunds : mfAllFunds.filter(f => f.cat === mfActiveCat);

    // Filter by search words ‚Äî ALL words must appear somewhere in name
    if (words.length) {
        pool = pool.filter(f => {
            const n = f.name.toLowerCase();
            return words.every(w => n.includes(w));
        });
    }

    if (!pool.length && !words.length) {
        // No search, no results ‚Äî show placeholder with count
        const total = mfActiveCat==='All' ? mfAllFunds.length : mfAllFunds.filter(f=>f.cat===mfActiveCat).length;
        $('#mfContent').html(`<div class="mf-empty-state"><i class="fas fa-search"></i>
            <p>Search within ${mfActiveCat==='All'?'all funds':mfActiveCat}</p>
            <span>${total.toLocaleString('en-IN')} Direct Growth funds available ¬∑ Type to search</span></div>`);
        return;
    }

    if (!pool.length) {
        $('#mfContent').html(`<div class="mf-empty-state"><i class="fas fa-inbox"></i>
            <p>No funds found for "${raw}"</p>
            <span>Try fewer or different keywords</span></div>`);
        return;
    }

    const show = pool.slice(0, 30);
    const more = pool.length - 30;
    const html = show.map(f => `
        <div class="mf-result-row" onclick="loadMFDetail(${f.code}, '${f.name.replace(/'/g,"\'")}')">
            <div class="mf-row-left">
                <div class="mf-row-name">${f.name}</div>
                <div class="mf-row-meta"><span class="mf-row-cat">${f.cat}</span></div>
            </div>
            <i class="fas fa-chevron-right mf-row-arrow"></i>
        </div>`).join('');
    const footer = more > 0 ? `<div class="mf-more-hint">Showing top 30 of ${pool.length.toLocaleString('en-IN')} results ‚Äî refine your search</div>` : `<div class="mf-more-hint">${pool.length} fund${pool.length!==1?'s':''} found</div>`;
    $('#mfContent').html('<div class="mf-results-list">' + html + footer + '</div>');
}

function loadMFDetail(code, name) {
    $('#mfContent').html('<div class="fp-loading"><i class="fas fa-spinner fa-spin"></i><span>Loading fund details‚Ä¶</span></div>');
    $.getJSON('/mf_detail/' + code)
        .done(function(d) {
            if (d.error) { $('#mfContent').html('<div class="mf-error">'+d.error+'</div>'); return; }
            function retBadge(val, label) {
                if (val === null || val === undefined) return `<div class="mf-ret-box mf-ret-na"><div class="mf-ret-label">${label}</div><div class="mf-ret-val">N/A</div></div>`;
                const up = val >= 0;
                return `<div class="mf-ret-box ${up?'mf-ret-up':'mf-ret-down'}">
                    <div class="mf-ret-label">${label}</div>
                    <div class="mf-ret-val">${up?'+':''}${val.toFixed(2)}%</div>
                </div>`;
            }
            $('#mfContent').html(`
                <div class="mf-detail-card">
                    <button class="mf-back-btn" onclick="runMFSearch(); $('#mfCatBar').show();"><i class="fas fa-arrow-left"></i> Back to results</button>
                    <div class="mf-detail-house">${d.fundHouse}</div>
                    <div class="mf-detail-name">${d.schemeName}</div>
                    <div class="mf-detail-tags">
                        <span class="mf-tag">${d.schemeType||''}</span>
                        <span class="mf-tag mf-tag-cat">${d.schemeCategory||''}</span>
                    </div>

                    <div class="mf-nav-box">
                        <div>
                            <div class="mf-nav-label">Latest NAV</div>
                            <div class="mf-nav-val">‚Çπ${parseFloat(d.latestNAV).toFixed(4)}</div>
                            <div class="mf-nav-date">as of ${d.navDate}</div>
                        </div>
                    </div>

                    <div class="mf-returns-title">Returns</div>
                    <div class="mf-returns-row">
                        ${retBadge(d.return_1y, '1 Year')}
                        ${retBadge(d.return_3y, '3 Years')}
                        ${retBadge(d.return_5y, '5 Years')}
                    </div>
                    <div class="fp-source-note" style="margin-top:14px;"><i class="fas fa-info-circle"></i> NAV data from AMFI via mfapi.in ¬∑ Returns are absolute % change</div>
                </div>`);
        })
        .fail(function() { $('#mfContent').html('<div class="mf-error"><i class="fas fa-wifi"></i> Could not fetch fund details.</div>'); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FINANCE GLOSSARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GLOSSARY = [
    // Stocks & Markets
    {t:"Stock / Share", d:"A small piece of ownership in a company. When you buy a share, you become a part-owner of that company.", c:"Stocks"},
    {t:"NSE", d:"National Stock Exchange ‚Äî India's largest stock exchange where stocks like Infosys and TCS are listed and traded.", c:"Stocks"},
    {t:"BSE", d:"Bombay Stock Exchange ‚Äî Asia's oldest stock exchange (1875). SENSEX is its benchmark index.", c:"Stocks"},
    {t:"Nifty 50", d:"An index of the top 50 companies listed on NSE by market capitalisation. Used to measure overall market performance.", c:"Stocks"},
    {t:"SENSEX", d:"An index of the top 30 companies on BSE. 'SENS' = Sensitive, 'EX' = Index. Tracks how the market moves.", c:"Stocks"},
    {t:"Bull Market", d:"A period when stock prices are rising and investor confidence is high. 'Bull' because bulls charge upward.", c:"Stocks"},
    {t:"Bear Market", d:"A period when stock prices fall 20% or more from recent highs. 'Bear' because bears swipe downward.", c:"Stocks"},
    {t:"Market Cap", d:"Total market value of a company = Share Price √ó Total Shares. Large-cap (>‚Çπ20,000 Cr), Mid-cap, Small-cap.", c:"Stocks"},
    {t:"IPO", d:"Initial Public Offering ‚Äî when a private company sells shares to the public for the first time to raise money.", c:"Stocks"},
    {t:"Dividend", d:"A portion of a company's profits paid to shareholders. If you own 100 shares and dividend is ‚Çπ5, you get ‚Çπ500.", c:"Stocks"},
    {t:"52-Week High/Low", d:"The highest and lowest price a stock traded at in the past 52 weeks. Used to gauge current price level.", c:"Stocks"},
    {t:"Circuit Breaker", d:"A mechanism that halts trading when a stock moves too much in a day (e.g. ¬±5%, ¬±10%, ¬±20%) to prevent panic.", c:"Stocks"},
    {t:"Demat Account", d:"Dematerialised Account ‚Äî holds your shares electronically instead of paper certificates. Required to trade in India.", c:"Stocks"},
    {t:"Intraday Trading", d:"Buying and selling stocks within the same trading day. You profit from short-term price movements.", c:"Stocks"},
    {t:"Delivery Trading", d:"Buying stocks and holding them beyond one day. The shares are delivered to your Demat account.", c:"Stocks"},
    {t:"Liquidity", d:"How easily an asset can be converted to cash. Cash is most liquid; real estate is least liquid.", c:"Stocks"},
    {t:"Volatility", d:"How much a stock's price fluctuates. High volatility = big price swings. Low volatility = stable prices.", c:"Stocks"},
    {t:"Rally", d:"A quick rise in stock prices over a short period. Can apply to individual stocks or the whole market.", c:"Stocks"},
    {t:"Correction", d:"A drop of 10%+ in stock price from a recent peak. Normal and healthy part of market cycles.", c:"Stocks"},
    // Ratios & Valuation
    {t:"P/E Ratio", d:"Price-to-Earnings Ratio = Share Price √∑ EPS. Shows how much investors pay per ‚Çπ1 of earnings. Lower can mean undervalued.", c:"Valuation"},
    {t:"EPS", d:"Earnings Per Share = Company Profit √∑ Total Shares. Tells you how much profit is attributed to each share.", c:"Valuation"},
    {t:"P/B Ratio", d:"Price-to-Book Ratio = Market Price √∑ Book Value per share. Compares stock price to company's net assets.", c:"Valuation"},
    {t:"Book Value", d:"Company's total assets minus total liabilities. The theoretical value if a company were liquidated today.", c:"Valuation"},
    {t:"EBITDA", d:"Earnings Before Interest, Taxes, Depreciation & Amortisation. Measures core business profitability.", c:"Valuation"},
    {t:"ROE", d:"Return on Equity = Net Profit √∑ Shareholders Equity √ó 100. Higher ROE means company uses investor money efficiently.", c:"Valuation"},
    {t:"ROA", d:"Return on Assets = Net Profit √∑ Total Assets √ó 100. Measures how efficiently a company uses its assets.", c:"Valuation"},
    {t:"Debt-to-Equity", d:"Total Debt √∑ Shareholders Equity. Lower ratio means less debt and lower risk. Very high = risky company.", c:"Valuation"},
    {t:"Dividend Yield", d:"Annual Dividend √∑ Share Price √ó 100. A yield of 3% means you earn ‚Çπ3 per year for every ‚Çπ100 invested.", c:"Valuation"},
    {t:"Face Value", d:"The original value of a share as stated in company documents ‚Äî usually ‚Çπ1, ‚Çπ2, or ‚Çπ10. Different from market price.", c:"Valuation"},
    // Mutual Funds
    {t:"Mutual Fund", d:"A pool of money from many investors managed by a professional fund manager who invests in stocks, bonds, etc.", c:"Mutual Funds"},
    {t:"NAV", d:"Net Asset Value ‚Äî the per-unit price of a mutual fund. NAV = (Total Assets - Liabilities) √∑ Total Units.", c:"Mutual Funds"},
    {t:"SIP", d:"Systematic Investment Plan ‚Äî investing a fixed amount every month in a mutual fund. Builds wealth through compounding.", c:"Mutual Funds"},
    {t:"ELSS", d:"Equity Linked Savings Scheme ‚Äî a tax-saving mutual fund with 3-year lock-in. Eligible for ‚Çπ1.5L deduction under 80C.", c:"Mutual Funds"},
    {t:"Expense Ratio", d:"Annual fee charged by a mutual fund as % of your investment. Lower is better. Direct plans have lower expense ratios.", c:"Mutual Funds"},
    {t:"Direct vs Regular", d:"Direct Plan: you invest directly with AMC, lower cost. Regular Plan: through distributor, higher expense ratio.", c:"Mutual Funds"},
    {t:"Exit Load", d:"A fee charged when you redeem (withdraw) from a mutual fund before a specified period (e.g. 1% if exited within 1 year).", c:"Mutual Funds"},
    {t:"AMFI", d:"Association of Mutual Funds in India ‚Äî regulatory body that governs and promotes mutual funds in India.", c:"Mutual Funds"},
    {t:"AMC", d:"Asset Management Company ‚Äî the company that manages your mutual fund. Examples: HDFC AMC, SBI Mutual Fund.", c:"Mutual Funds"},
    {t:"Fund Manager", d:"A professional who decides which stocks/bonds to buy and sell inside a mutual fund based on research.", c:"Mutual Funds"},
    {t:"Index Fund", d:"A mutual fund that simply copies a market index like Nifty 50. Low cost, no active management.", c:"Mutual Funds"},
    {t:"Lump Sum", d:"Investing a large amount all at once in a mutual fund, as opposed to SIP (monthly instalments).", c:"Mutual Funds"},
    {t:"Redemption", d:"Withdrawing your money from a mutual fund. The units are sold at the current NAV.", c:"Mutual Funds"},
    // Fixed Income
    {t:"Fixed Deposit (FD)", d:"A bank deposit that earns a guaranteed interest rate for a fixed tenure. Safe but returns are taxable.", c:"Fixed Income"},
    {t:"Bond", d:"A loan you give to a company or government. They pay you regular interest and return principal at maturity.", c:"Fixed Income"},
    {t:"Yield", d:"The actual return on a bond or FD. A bond priced below face value has higher yield than its coupon rate.", c:"Fixed Income"},
    {t:"Coupon Rate", d:"The annual interest rate paid by a bond. A 7% bond with ‚Çπ1,000 face value pays ‚Çπ70/year.", c:"Fixed Income"},
    {t:"Maturity", d:"The date when a loan, bond or FD repays the original principal amount to the investor.", c:"Fixed Income"},
    {t:"PPF", d:"Public Provident Fund ‚Äî government-backed savings scheme with 15-year lock-in, 7.1% interest (tax-free), 80C benefit.", c:"Fixed Income"},
    {t:"NPS", d:"National Pension System ‚Äî government pension scheme where you invest regularly for retirement. Tax benefit under 80CCD.", c:"Fixed Income"},
    // Loans & EMI
    {t:"EMI", d:"Equated Monthly Instalment ‚Äî fixed monthly payment for a loan covering principal + interest. Stays constant throughout tenure.", c:"Loans"},
    {t:"Principal", d:"The original amount borrowed. EMI payments first cover interest; later instalments reduce the principal.", c:"Loans"},
    {t:"Interest Rate", d:"The cost of borrowing money, expressed as % per year. Home loans ~8-9%, Personal loans ~12-18%.", c:"Loans"},
    {t:"Tenure", d:"The duration of a loan ‚Äî how many months/years you take to repay it. Longer tenure = lower EMI but more interest.", c:"Loans"},
    {t:"Prepayment", d:"Paying extra toward a loan before the scheduled date. Reduces principal and total interest paid.", c:"Loans"},
    {t:"Credit Score", d:"A 3-digit number (300-900) measuring your creditworthiness. 750+ is considered good. Affects loan approval and rates.", c:"Loans"},
    {t:"CIBIL", d:"India's main credit bureau that generates credit scores. Banks check your CIBIL before approving loans.", c:"Loans"},
    {t:"Collateral", d:"An asset pledged as security for a loan. If you can't repay, the lender can seize it (e.g. house for home loan).", c:"Loans"},
    // Tax & Regulations
    {t:"SEBI", d:"Securities and Exchange Board of India ‚Äî regulates the stock market, mutual funds, and brokers. India's equivalent of SEC.", c:"Tax & Regulation"},
    {t:"RBI", d:"Reserve Bank of India ‚Äî India's central bank. Controls monetary policy, interest rates, and regulates banks.", c:"Tax & Regulation"},
    {t:"Section 80C", d:"A tax deduction of up to ‚Çπ1.5 lakh on investments like PPF, ELSS, LIC premium, home loan principal.", c:"Tax & Regulation"},
    {t:"LTCG", d:"Long Term Capital Gains ‚Äî profit from selling assets held >1 year (equity) or >2/3 years (others). Taxed at 12.5%.", c:"Tax & Regulation"},
    {t:"STCG", d:"Short Term Capital Gains ‚Äî profit from selling equity held <1 year. Taxed at 20%.", c:"Tax & Regulation"},
    {t:"TDS", d:"Tax Deducted at Source ‚Äî tax automatically deducted from FD interest, salary, etc. before you receive it.", c:"Tax & Regulation"},
    {t:"PAN Card", d:"Permanent Account Number ‚Äî 10-digit ID for all financial transactions in India. Mandatory for investments > ‚Çπ50,000.", c:"Tax & Regulation"},
    // General Finance
    {t:"Compounding", d:"Earning returns on your returns. ‚Çπ10,000 at 10% ‚Üí ‚Çπ11,000 year 1 ‚Üí ‚Çπ12,100 year 2. The most powerful wealth-building force.", c:"General"},
    {t:"Inflation", d:"The rise in prices over time. If inflation is 6%, something costing ‚Çπ100 today costs ‚Çπ106 next year.", c:"General"},
    {t:"Real Return", d:"Return after adjusting for inflation. If your FD gives 7% but inflation is 6%, real return is only ~1%.", c:"General"},
    {t:"Asset Allocation", d:"How you split investments between stocks, bonds, gold, real estate etc. Diversification reduces risk.", c:"General"},
    {t:"Diversification", d:"Spreading investments across different assets so one bad investment doesn't ruin your portfolio.", c:"General"},
    {t:"Risk-Return Tradeoff", d:"Higher potential return always comes with higher risk. FDs are safe but low return; stocks are risky but high return.", c:"General"},
    {t:"Portfolio", d:"Your complete collection of investments ‚Äî stocks, MFs, FDs, gold, real estate all together.", c:"General"},
    {t:"Net Worth", d:"Total assets minus total liabilities. What you'd have if you sold everything and paid all debts.", c:"General"},
    {t:"Liquidity Risk", d:"Risk that you can't quickly convert an investment to cash when needed. Real estate has high liquidity risk.", c:"General"},
    {t:"Step-up SIP", d:"A SIP where the monthly amount increases by a fixed % every year (e.g. 10%). Builds wealth faster than flat SIP.", c:"General"},
    {t:"Rupee Cost Averaging", d:"SIP benefit: buying more units when price is low, fewer when high. Averages your cost over time.", c:"General"},
    {t:"Power of Compounding", d:"The exponential growth of money when returns are reinvested. ‚Çπ5,000/month at 12% for 30 years ‚Üí ~‚Çπ1.76 crore!", c:"General"},
];

let glossaryInited = false;
let activeGlossCat = 'All';

function initGlossary() {
    if (glossaryInited) return;
    glossaryInited = true;

    // Build category filter pills
    const cats = ['All', ...new Set(GLOSSARY.map(g => g.c))];
    const catHtml = cats.map(c =>
        `<button class="gloss-cat-btn ${c==='All'?'active':''}" onclick="setGlossCat('${c}')">${c}</button>`
    ).join('');
    $('#glossaryCats').html(catHtml);
    renderGlossary();
}

function setGlossCat(cat) {
    activeGlossCat = cat;
    $('.gloss-cat-btn').removeClass('active');
    $(`.gloss-cat-btn`).filter(function(){ return $(this).text() === cat; }).addClass('active');
    renderGlossary();
}

function filterGlossary() {
    renderGlossary();
}

function renderGlossary() {
    const q = ($('#glossarySearch').val() || '').toLowerCase();
    let items = GLOSSARY;
    if (activeGlossCat !== 'All') items = items.filter(g => g.c === activeGlossCat);
    if (q) items = items.filter(g => g.t.toLowerCase().includes(q) || g.d.toLowerCase().includes(q));

    if (!items.length) {
        $('#glossaryContent').html('<div class="mf-empty-state"><i class="fas fa-book"></i><p>No terms found</p></div>');
        return;
    }

    const html = items.map(g => `
        <div class="gloss-item">
            <div class="gloss-term">${g.t}<span class="gloss-cat-pill">${g.c}</span></div>
            <div class="gloss-def">${g.d}</div>
        </div>`).join('');
    $('#glossaryContent').html('<div class="gloss-list">' + html + `<div class="fp-source-note" style="margin-top:12px;"><i class="fas fa-info-circle"></i> ${items.length} terms shown ¬∑ Definitions simplified for beginners</div></div>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZAKAT CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitZakat() {
    const cash      = parseFloat($('#zCash').val())     || 0;
    const savings   = parseFloat($('#zSavings').val())  || 0;
    const stocks    = parseFloat($('#zStocks').val())   || 0;
    const mf        = parseFloat($('#zMF').val())       || 0;
    const business  = parseFloat($('#zBusiness').val()) || 0;
    const goldG     = parseFloat($('#zGoldGrams').val())|| 0;
    const silverG   = parseFloat($('#zSilverGrams').val())|| 0;
    const debts     = parseFloat($('#zDebts').val())    || 0;

    showResults();
    $('#resultsContent').html('<div class="fp-loading"><i class="fas fa-spinner fa-spin"></i><span>Fetching live gold price for Nisab‚Ä¶</span></div>');

    // Fetch live gold/silver price to compute Nisab
    $.getJSON('/metals')
        .done(function(d) {
            // Gold price per gram in INR
            const goldPerGram   = d.gold   ? d.gold.price_inr   / 10 : 7500; // fallback ‚Çπ7500/g
            const silverPerGram = d.silver ? d.silver.price_inr / 1000 : 90;  // fallback ‚Çπ90/g

            // Nisab = 85g gold standard (most widely used for cash/investments)
            const nisabGold   = 85   * goldPerGram;
            const nisabSilver = 595  * silverPerGram;
            // Use gold Nisab for cash/investments (stricter, more common)
            const nisab = nisabGold;

            // Gold & Silver monetary values
            const goldValue   = goldG   * goldPerGram;
            const silverValue = silverG * silverPerGram;

            // Total zakatable wealth
            const grossWealth = cash + savings + stocks + mf + business + goldValue + silverValue;
            const netWealth   = grossWealth - debts;
            const zakatDue    = netWealth >= nisab ? netWealth * 0.025 : 0;
            const zakatDuePct = 2.5;
            const eligible    = netWealth >= nisab;

            const fmt  = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
            const fmtD = v => '‚Çπ' + v.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

            // Breakdown rows
            const rows = [
                { label: 'Cash & Bank Balance',    val: cash,      icon: 'fas fa-money-bill-wave', color: '#3b82f6' },
                { label: 'Savings / FD',            val: savings,   icon: 'fas fa-piggy-bank',      color: '#3b82f6' },
                { label: 'Stocks (market value)',   val: stocks,    icon: 'fas fa-chart-line',      color: '#8b5cf6' },
                { label: 'Mutual Funds',            val: mf,        icon: 'fas fa-layer-group',     color: '#8b5cf6' },
                { label: 'Business / Receivables',  val: business,  icon: 'fas fa-briefcase',       color: '#8b5cf6' },
                { label: `Gold (${goldG}g √ó ‚Çπ${Math.round(goldPerGram)}/g)`,   val: goldValue,   icon: 'fas fa-gem', color: '#f59e0b' },
                { label: `Silver (${silverG}g √ó ‚Çπ${Math.round(silverPerGram)}/g)`, val: silverValue, icon: 'fas fa-gem', color: '#94a3b8' },
            ].filter(r => r.val > 0);

            $('#resultsContent').html(`
                <div class="result-header">
                    <h3><i class="fas fa-star-and-crescent"></i> Zakat Calculation</h3>
                </div>
                <div class="result-body">

                    <!-- Zakat due hero -->
                    <div class="zakat-hero ${eligible ? 'zakat-eligible' : 'zakat-ineligible'}">
                        <div class="zakat-hero-label">${eligible ? 'Zakat Due (2.5%)' : 'Zakat Not Applicable'}</div>
                        <div class="zakat-hero-value">${eligible ? fmtD(zakatDue) : '‚Äî'}</div>
                        <div class="zakat-hero-sub">
                            ${eligible
                                ? `Your net wealth ‚Çπ${Math.round(netWealth).toLocaleString('en-IN')} exceeds Nisab of ${fmt(nisab)}`
                                : `Your net wealth ${fmt(netWealth)} is below Nisab of ${fmt(nisab)}`}
                        </div>
                    </div>

                    <!-- Nisab info -->
                    <div class="zakat-nisab-bar">
                        <div class="zakat-nisab-left">
                            <div class="zakat-nisab-title">Nisab Threshold</div>
                            <div class="zakat-nisab-vals">
                                <span><strong>Gold (85g):</strong> ${fmt(nisabGold)}</span>
                                <span><strong>Silver (595g):</strong> ${fmt(nisabSilver)}</span>
                            </div>
                            <div class="zakat-nisab-note">Using live prices via MCX Futures ¬∑ Gold standard applied</div>
                        </div>
                        <div class="zakat-nisab-status ${eligible ? 'status-eligible' : 'status-not'}">
                            ${eligible ? '‚úì Eligible' : '‚úó Not Eligible'}
                        </div>
                    </div>

                    <!-- Asset breakdown -->
                    <div class="stepsip-compare">
                        <div class="stepsip-compare-title"><i class="fas fa-list"></i> Asset Breakdown</div>
                        ${rows.map(r => `
                        <div class="stepsip-compare-row">
                            <span><i class="${r.icon}" style="color:${r.color};width:16px;text-align:center;margin-right:7px;"></i>${r.label}</span>
                            <strong>${fmt(r.val)}</strong>
                        </div>`).join('')}
                        <div class="stepsip-compare-row" style="border-top:2px solid #e2e8f0;margin-top:4px;padding-top:10px;">
                            <span><strong>Gross Zakatable Wealth</strong></span>
                            <strong style="color:#0f172a;">${fmt(grossWealth)}</strong>
                        </div>
                        ${debts > 0 ? `
                        <div class="stepsip-compare-row">
                            <span><i class="fas fa-minus-circle" style="color:#ef4444;margin-right:7px;"></i>Liabilities (Debts)</span>
                            <strong style="color:#ef4444;">‚àí ${fmt(debts)}</strong>
                        </div>` : ''}
                        <div class="stepsip-compare-row" style="background:#f8fafc;border-radius:8px;padding:10px 12px;margin-top:4px;">
                            <span><strong>Net Zakatable Wealth</strong></span>
                            <strong style="font-size:1rem;color:${eligible?'#16a34a':'#dc2626'};">${fmt(netWealth)}</strong>
                        </div>
                    </div>

                    ${eligible ? `
                    <!-- Payment options -->
                    <div class="zakat-payment-box">
                        <div class="zakat-payment-title"><i class="fas fa-hand-holding-heart"></i> Zakat Payment Options</div>
                        <div class="zakat-payment-row">
                            <span>Pay in full now</span>
                            <strong>${fmtD(zakatDue)}</strong>
                        </div>
                        <div class="zakat-payment-row">
                            <span>Monthly (spread over 12 months)</span>
                            <strong>${fmtD(zakatDue/12)} /month</strong>
                        </div>
                        <div class="zakat-payment-row">
                            <span>Weekly</span>
                            <strong>${fmtD(zakatDue/52)} /week</strong>
                        </div>
                    </div>` : ''}

                    <div class="result-note" style="margin-top:14px;">
                        * Gold & Silver prices fetched live. Zakat applies to wealth held for one complete lunar year (Hawl).
                        Consult a scholar for complex assets like business equity or agricultural produce.
                    </div>
                    ${addBackButton()}
                </div>`);
        })
        .fail(function() {
            // Fallback with standard gold price if /metals fails
            const goldPerGram = 7500;
            const nisab = 85 * goldPerGram;
            const goldValue   = (parseFloat($('#zGoldGrams').val())||0) * goldPerGram;
            const silverValue = (parseFloat($('#zSilverGrams').val())||0) * 90;
            const grossWealth = cash + savings + stocks + mf + business + goldValue + silverValue;
            const netWealth   = grossWealth - debts;
            const zakatDue    = netWealth >= nisab ? netWealth * 0.025 : 0;
            const eligible    = netWealth >= nisab;
            const fmtD = v => '‚Çπ' + v.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            const fmt  = v => '‚Çπ' + Math.round(v).toLocaleString('en-IN');
            $('#resultsContent').html(`
                <div class="result-header"><h3><i class="fas fa-star-and-crescent"></i> Zakat Calculation</h3></div>
                <div class="result-body">
                    <div class="zakat-hero ${eligible?'zakat-eligible':'zakat-ineligible'}">
                        <div class="zakat-hero-label">${eligible?'Zakat Due (2.5%)':'Zakat Not Applicable'}</div>
                        <div class="zakat-hero-value">${eligible?fmtD(zakatDue):'‚Äî'}</div>
                        <div class="zakat-hero-sub">${eligible?`Net wealth ${fmt(netWealth)} exceeds Nisab ${fmt(nisab)}`:`Net wealth ${fmt(netWealth)} below Nisab ${fmt(nisab)}`}</div>
                    </div>
                    <div class="result-note">* Using estimated gold price ‚Çπ7,500/g (live price unavailable). ${addBackButton()}</div>
                </div>`);
        });
}

</script>
</body>
</html>